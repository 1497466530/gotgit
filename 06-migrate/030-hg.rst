Hg 版本库到Git的迁移
=====================

Mercurial（水银）是和 Git 同时代的、与之齐名的一款著名的分布式版本控制系统，也有相当多的使用者。就像水银又名汞，作为版本控制系统的 Mercurial 又称作 Hg（水银元素符号）。Hg 具有简单易用的优点，至少 Hg 提交的顺序递增的数字编号让 Subversion 用户感到更为亲切。Hg 的开发语言除少部分因性能原因使用 C 语言外，大部分用 Python 语言开发完成，因而更易扩展，最终形成了 Hg 最具特色的插件系统。例如 MQ 就是 Hg 一个很有用的插件，通过 Quilt 式的补丁集实现对定制开发的特性分支的版本控制，当然 StGit 和 Topgit 也可以实现类似的功能。

但是 Hg 存在一些不足。例如服务器的存储效率不能和 Git 相比，服务器存储空间占用更大。Hg 还不支持真正的分支，只能通过版本库克隆来进行分支开发。因为 Hg 不支持真正的分支，所以不能向 git-svn 那样完整的将 Subversion 版本库转换和互操作。Hg 的速度相比 Git 要慢，尤其是网络操作没有像 Git 一样精确的进度显示。Hg 提交只能回退一次，要想多次回退和整理版本库需要用到 MQ 插件。作为定制开发的利器 Hg+MQ 不适合多人协作开发而 Git+Topgit 更为适合。

不论是何原因想从 Hg 迁移到 Git，用一个名为 fast-export 的转换工具可以很方便的实现。fast-export 是一个用 Python 开发的命令行工具，可以将本地的 Hg 版本库迁移为 Git 版本库。

安装 fast-export 非常简单，只要用 Git 克隆 fast-export 的版本库即可。

::

  $ cd /path/to
  $ git clone git://repo.or.cz/fast-export.git

完成克隆后，会看到 `/path/to/fast-export` 目录中有一个名为 `hg-fast-import.sh` 的脚本文件，该文件封装了对相应 Python 脚本的调用。使用该脚本可以实现 Hg 版本库到 Git 版本库的迁移。

下面就演示一下 Hg 版本库到 Git 版本库的转换。

* 要转换的 Hg 版本库位于路径 `/path/to/hg/mydoc/.hg` 下。

  查看 Hg 版本库中的最新版本。

  ::

    $ hg tip
    修改集:      831:41a54016264b
    分支:        jiangxin
    标签:        tip
    用户:        Jiang Xin <worldhello.net AT gmail DOT com>
    日期:        Wed Sep 01 09:25:47 2010 +0800
    摘要:        backup

* 初始化一个 Git 版本库，该版本库就是迁移的目标版本库。

  ::

    $ mkdir -p /path/to/my/workspace/mydoc
    $ cd /path/to/my/workspace/mydoc
    $ git init
    Initialized empty Git repository in /path/to/my/workspace/mydoc/.git/

* 在刚刚完成初始化的 Git 工作区中调用 `hg-fast-export.sh` 脚本完成版本库转换。

  ::

    $ /path/to/fast-export/hg-fast-export.sh -r /path/to/hg/mydoc
    tech: Exporting full revision 1/832 with 97/0/0 added/changed/removed files
    tech: Exporting simple delta revision 2/832 with 24/0/0 added/changed/removed files
    ...
    jiangxin: Exporting simple delta revision 831/832 with 1/3/0 added/changed/removed files
    jiangxin: Exporting simple delta revision 832/832 with 3/0/0 added/changed/removed files
    Issued 832 commands
    git-fast-import statistics:
    ---------------------------------------------------------------------
    Alloc'd objects:       5000
    Total objects:         4773 (      1110 duplicates                  )
          blobs  :         1789 (       837 duplicates       1070 deltas)
          trees  :         2152 (       273 duplicates       1607 deltas)
          commits:          832 (         0 duplicates          0 deltas)
          tags   :            0 (         0 duplicates          0 deltas)
    Total branches:           6 (         8 loads     )
          marks:           1024 (       832 unique    )
          atoms:            808
    Memory total:          2294 KiB
           pools:          2098 KiB
         objects:           195 KiB
    ---------------------------------------------------------------------
    pack_report: getpagesize()            =       4096
    pack_report: core.packedGitWindowSize =   33554432
    pack_report: core.packedGitLimit      =  268435456
    pack_report: pack_used_ctr            =       8431
    pack_report: pack_mmap_calls          =       2214
    pack_report: pack_open_windows        =          2 /          5
    pack_report: pack_mapped              =   34154918 /  167772160
    ---------------------------------------------------------------------

在转换后的 Git 版本库目录中，保存了几个用于记录版本库转换进度的状态文件（.git/hg2git-\*），当在 Git 工作区不带任何参数执行 `hg-fast-export.sh` 命令时，会继续增量式的进行转换，将 Hg 版本库中的新提交迁移到 Git 版本库中。
