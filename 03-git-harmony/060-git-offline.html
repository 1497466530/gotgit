
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>3.6. 补丁文件交互 &mdash; GotGit</title>
    
    <link rel="stylesheet" href="../static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="/stylesheets/master.css" type="text/css" />
    <link rel="stylesheet" href="/stylesheets/syntax.css" type="text/css" />
    <link rel="stylesheet" href="../static/worldhello.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../static/jquery.js"></script>
    <script type="text/javascript" src="../static/underscore.js"></script>
    <script type="text/javascript" src="../static/doctools.js"></script>
    <script type="text/javascript" src="../static/translations.js"></script>
    <link rel="top" title="GotGit" href="../index.html" />
    <link rel="up" title="3. Git和声" href="index.html" />
    <link rel="next" title="4. Git协同模型" href="../04-git-model/index.html" />
    <link rel="prev" title="3.5. 远程版本库" href="050-git-remote.html" /> 
  </head>
  <body>
    <div id='header'>
      <h1><a href='/'>World Hello</a></h1>

      <div id='menu'>
        <ul>
          <li><a href='/' id='home-link' title='Home'>首页</a></li>
          <li><a href='/blog.html' id='blog-link' title='Blog'>博客</a></li>
          <li><a href='/doc/' id='docs-link' title='Docs'>文章</a></li>
          <li><a href='/about.html' id='about-link' title='About'>关于</a></li>
          <li><a href='http://github.com/gotgit' target='_blank' title='GitHub' rel='me' id='github-link'>GitHub</a></li>
          <li><a href='http://weibo.com/gotgit' title='微博' target='_blank' id='weibo-link'>微博</a></li>
        </ul>
      </div>
    </div>

    <div class="related">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="总目录"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="../04-git-model/index.html" title="4. Git协同模型"
             accesskey="N">下一页</a> |</li>
        <li class="right" >
          <a href="050-git-remote.html" title="3.5. 远程版本库"
             accesskey="P">上一页</a> |</li>
        <li><a href="../index.html">GotGit</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">3. Git和声</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">內容目录</a></h3>
  <ul>
<li><a class="reference internal" href="#">3.6. 补丁文件交互</a><ul>
<li><a class="reference internal" href="#id2">3.6.1. 创建补丁</a></li>
<li><a class="reference internal" href="#id3">3.6.2. 应用补丁</a></li>
<li><a class="reference internal" href="#stgitquilt">3.6.3. StGit和Quilt</a><ul>
<li><a class="reference internal" href="#stgit">3.6.3.1. StGit</a></li>
<li><a class="reference internal" href="#quilt">3.6.3.2. Quilt</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>上一个主题</h4>
  <p class="topless"><a href="050-git-remote.html"
                        title="上一章">3.5. 远程版本库</a></p>
  <h4>下一个主题</h4>
  <p class="topless"><a href="../04-git-model/index.html"
                        title="下一章">4. Git协同模型</a></p>
  <h3>本页</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/03-git-harmony/060-git-offline.txt"
           rel="nofollow">显示源代码</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>快速搜索</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="转向" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    输入相关的术语，模块，类或者函数名称进行搜索
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="id1">
<h1>3.6. 补丁文件交互<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h1>
<p>之前各个章节版本库间的交互都是通过<strong class="command">git push</strong>和/或<strong class="command">git pull</strong>命令实现的，这是Git最主要的交互模式，但并不是全部。使用补丁文件是另外一种交互方式，适用于参与者众多的大型项目进行分布式开发。例如Git项目本身的代码提交就主要由贡献者通过邮件传递补丁文件实现的。作者在写书过程中发现了Git的两个bug，就是以补丁形式通过邮件贡献给Git项目的，下面两个链接就是相关邮件的存档。</p>
<ul>
<li><p class="first">关于Git文档错误的bugfix：</p>
<p><a class="reference external" href="http://marc.info/?l=git&amp;m=129248415230151">http://marc.info/?l=git&amp;m=129248415230151</a></p>
</li>
<li><p class="first">关于<strong class="command">git-apply</strong>的一个bugfix：</p>
<p><a class="reference external" href="http://article.gmane.org/gmane.comp.version-control.git/162100">http://article.gmane.org/gmane.comp.version-control.git/162100</a></p>
</li>
</ul>
<p>这种使用补丁文件进行提交的方式可以提高项目的参与度。因为任何人都可以参与项目的开发，只要会将提交转化为补丁，会发邮件即可。</p>
<div class="section" id="id2">
<h2>3.6.1. 创建补丁<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<p>Git提供了将提交批量转换为补丁文件的命令：<strong class="command">git format-patch</strong>。该命令后面的参数是一个版本范围列表，会将包含在此列表中的提交一一转换为补丁文件，每个补丁文件包含一个序号并从提交说明中提取字符串作为文件名。</p>
<p>下面演示一下在user1工作区中，如何将<tt class="docutils literal"><span class="pre">master</span></tt>分支的最近3个提交转换为补丁文件。</p>
<ul>
<li><p class="first">进入user1工作区，切换到<tt class="docutils literal"><span class="pre">master</span></tt>分支。</p>
<div class="highlight-python"><div class="highlight"><pre>$ cd /path/to/user1/workspace/hello-world/
$ git checkout master
$ git pull
</pre></div>
</div>
</li>
<li><p class="first">执行下面的命令将最近三个提交转换为补丁文件。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git format-patch -s HEAD~3..HEAD
0001-Fix-typo-help-to-help.patch
0002-Add-I18N-support.patch
0003-Translate-for-Chinese.patch
</pre></div>
</div>
</li>
</ul>
<p>在上面的<strong class="command">git format-patch</strong>命令中使用了<tt class="docutils literal"><span class="pre">-s</span></tt>参数，会在导出的补丁文件中添加当前用户的签名。这个签名并非GnuPG式的数字签名，不过是将作者姓名添加到提交说明中而已，和在本书第2篇开头介绍的<strong class="command">git commit -s</strong>命令的效果相同。虽然签名很不起眼，但是对于以补丁方式提交数据却非常重要，因为以补丁方式提交可能因为合并冲突或其他原因使得最终提交的作者显示为管理员（提交者）的ID，在提交说明中加入原始作者的署名信息大概是作者唯一露脸的机会。如果在提交时忘了使用<tt class="docutils literal"><span class="pre">-s</span></tt>参数添加签名，可以在用<strong class="command">git format-path</strong>命令创建补丁文件的时候补救。</p>
<p>看一下补丁文件的文件头，在下面代码中的第7行可以看到新增的签名。</p>
<div class="highlight-python"><div class="highlight"><pre> 1 From d81896e60673771ef1873b27a33f52df75f70515 Mon Sep 17 00:00:00 2001
 2 From: user1 &lt;user1@sun.ossxp.com&gt;
 3 Date: Mon, 3 Jan 2011 23:48:56 +0800
 4 Subject: [PATCH 1/3] Fix typo: -help to --help.
 5
 6
 7 Signed-off-by: user1 &lt;user1@sun.ossxp.com&gt;
 8 ---
 9  src/main.c |    2 +-
10  1 files changed, 1 insertions(+), 1 deletions(-)
</pre></div>
</div>
<p>补丁文件有一个类似邮件一样的文件头（第1-4行），提交日志的第一行作为邮件标题（Subject），其余提交说明作为邮件内容（如果有的话），文件补丁用三个横线和提交说明分开。</p>
<p>实际上这些补丁文件可以直接拿来作为邮件发送给项目的负责人。Git提供了一个辅助邮件发送的命令<strong class="command">git send-email</strong>。下面用该命令将这三个补丁文件以邮件形式发送出去。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git send-email *.patch
0001-Fix-typo-help-to-help.patch
0002-Add-I18N-support.patch
0003-Translate-for-Chinese.patch
The following files are 8bit, but do not declare a Content-Transfer-Encoding.
    0002-Add-I18N-support.patch
    0003-Translate-for-Chinese.patch
Which 8bit encoding should I declare [UTF-8]?
Who should the emails appear to be from? [user1 &lt;user1@sun.ossxp.com&gt;]

Emails will be sent from: user1 &lt;user1@sun.ossxp.com&gt;
Who should the emails be sent to? jiangxin
Message-ID to be used as In-Reply-To for the first email?
...
Send this email? ([y]es|[n]o|[q]uit|[a]ll): a
...
</pre></div>
</div>
<p>命令<strong class="command">git send-email</strong>提供交互式字符界面，输入正确的收件人地址，邮件就批量地发送出去了。</p>
</div>
<div class="section" id="id3">
<h2>3.6.2. 应用补丁<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<p>在前面通过<strong class="command">git send-email</strong>命令发送邮件给<tt class="docutils literal"><span class="pre">jiangxin</span></tt>用户。现在使用 Linux 上的<strong class="command">mail</strong>命令检查一下邮件。</p>
<div class="highlight-python"><div class="highlight"><pre>$ mail
Mail version 8.1.2 01/15/2001.  Type ? for help.
&quot;/var/mail/jiangxin&quot;: 3 messages 3 unread
&gt;N  1 user1@sun.ossxp.c  Thu Jan 13 18:02   38/1120  [PATCH 1/3] Fix typo: -help to --help.
 N  2 user1@sun.ossxp.c  Thu Jan 13 18:02  227/6207  =?UTF-8?q?=5BPATCH=202/3=5D=20Add=20I18N=20support=2E?=
 N  3 user1@sun.ossxp.c  Thu Jan 13 18:02   95/2893  =?UTF-8?q?=5BPATCH=203/3=5D=20Translate=20for=20Chinese=2E?=
&amp;
</pre></div>
</div>
<p>如果邮件不止这三封，需要将三个包含补丁的邮件挑选出来保存到另外的文件中。
在 mail 命令的提示符(<cite>&amp;</cite>)下输入命令。</p>
<div class="highlight-python"><div class="highlight"><pre>&amp; s 1-3 user1-mail-archive
&quot;user1-mail-archive&quot; [New file]
&amp; q
</pre></div>
</div>
<p>上面的操作在本地创建了一个由开发者user1的补丁邮件组成的归档文件<tt class="docutils literal"><span class="pre">user1-mail-archive</span></tt>，这个文件是mbox格式的，可以用<strong class="command">mail</strong>命令打开。</p>
<div class="highlight-python"><div class="highlight"><pre>$ mail -f user1-mail-archive
Mail version 8.1.2 01/15/2001.  Type ? for help.
&quot;user1-mail-archive&quot;: 3 messages
&gt;   1 user1@sun.ossxp.c  Thu Jan 13 18:02   38/1121  [PATCH 1/3] Fix typo: -help to --help.
    2 user1@sun.ossxp.c  Thu Jan 13 18:02  227/6208  =?UTF-8?q?=5BPATCH=202/3=5D=20Add=20I18N=20support=2E?=
    3 user1@sun.ossxp.c  Thu Jan 13 18:02   95/2894  =?UTF-8?q?=5BPATCH=203/3=5D=20Translate=20for=20Chinese=2E?=
&amp; q
</pre></div>
</div>
<p>保存在mbox中的邮件可以批量的应用在版本库中，使用<strong class="command">git am</strong>命令。<tt class="docutils literal"><span class="pre">am</span></tt>是<tt class="docutils literal"><span class="pre">apply</span> <span class="pre">email</span></tt>的缩写。下面就演示一下如何应用补丁。</p>
<ul>
<li><p class="first">基于<tt class="docutils literal"><span class="pre">HEAD~3</span></tt>版本创建一个本地分支，以便在该分支下应用补丁。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git checkout -b user1 HEAD~3
Switched to a new branch &#39;user1&#39;
</pre></div>
</div>
</li>
<li><p class="first">将mbox文件<tt class="docutils literal"><span class="pre">user1-mail-archive</span></tt>中的补丁全部应用在当前分支上。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git am user1-mail-archive
Applying: Fix typo: -help to --help.
Applying: Add I18N support.
Applying: Translate for Chinese.
</pre></div>
</div>
</li>
<li><p class="first">补丁成功应用上了，看看提交日志。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git log -3 --pretty=fuller
commit 2d9276af9df1a2fdb71d1e7c9ac6dff88b2920a1
Author:     Jiang Xin &lt;jiangxin@ossxp.com&gt;
AuthorDate: Thu Jan 13 18:02:03 2011 +0800
Commit:     user1 &lt;user1@sun.ossxp.com&gt;
CommitDate: Thu Jan 13 18:21:16 2011 +0800

    Translate for Chinese.

    Signed-off-by: Jiang Xin &lt;jiangxin@ossxp.com&gt;
    Signed-off-by: user1 &lt;user1@sun.ossxp.com&gt;

commit 41227f492ad37cdd99444a5f5cc0c27288f2bca4
Author:     Jiang Xin &lt;jiangxin@ossxp.com&gt;
AuthorDate: Thu Jan 13 18:02:02 2011 +0800
Commit:     user1 &lt;user1@sun.ossxp.com&gt;
CommitDate: Thu Jan 13 18:21:15 2011 +0800

    Add I18N support.

    Signed-off-by: Jiang Xin &lt;jiangxin@ossxp.com&gt;
    Signed-off-by: user1 &lt;user1@sun.ossxp.com&gt;

commit 4a3380fb7ae90039633dec84acc2aab85398efad
Author:     user1 &lt;user1@sun.ossxp.com&gt;
AuthorDate: Thu Jan 13 18:02:01 2011 +0800
Commit:     user1 &lt;user1@sun.ossxp.com&gt;
CommitDate: Thu Jan 13 18:21:15 2011 +0800

    Fix typo: -help to --help.

    Signed-off-by: user1 &lt;user1@sun.ossxp.com&gt;
</pre></div>
</div>
</li>
</ul>
<p>从提交信息上可以看出：</p>
<ul class="simple">
<li>提交的时间信息使用了邮件发送的时间。</li>
<li>作者（Author）的信息被保留，和补丁文件中的一致。</li>
<li>提交者（Commit）全都设置为<tt class="docutils literal"><span class="pre">user1</span></tt>，因为提交是在<tt class="docutils literal"><span class="pre">user1</span></tt>的工作区完成的。</li>
<li>提交说明中的签名信息被保留。实际上<strong class="command">git am</strong>命令也可以提供<tt class="docutils literal"><span class="pre">-s</span></tt>参数，在提交说明中附加执行命令用户的签名。</li>
</ul>
<p>对于不习惯在控制台用<strong class="command">mail</strong>命令接收邮件的用户，可以通过邮件附件，U盘或其他方式获取<strong class="command">git format-patch</strong>生成的补丁文件，将补丁文件保存在本地，通过管道符调用<strong class="command">git am</strong>命令应用补丁。</p>
<div class="highlight-python"><div class="highlight"><pre>$ ls *.patch
0001-Fix-typo-help-to-help.patch  0002-Add-I18N-support.patch  0003-Translate-for-Chinese.patch
$ cat *.patch | git am
Applying: Fix typo: -help to --help.
Applying: Add I18N support.
Applying: Translate for Chinese.
</pre></div>
</div>
<p>Git还提供一个命令<strong class="command">git apply</strong>，可以应用一般格式的补丁文件，但是不能执行提交，也不能保持补丁中的作者信息。实际上<strong class="command">git apply</strong>命令和 GNU<strong class="command">patch</strong>命令类似，细微差别在本书第7篇第38章“补丁中的二进制文件”予以介绍。</p>
</div>
<div class="section" id="stgitquilt">
<h2>3.6.3. StGit和Quilt<a class="headerlink" href="#stgitquilt" title="永久链接至标题">¶</a></h2>
<p>一个复杂功能的开发一定是由多个提交来完成的，对于在以接收和应用补丁文件为开发模式的项目中，复杂的功能需要通过多个补丁文件来完成。补丁文件因为要经过审核才能被接受，因此针对一个功能的多个补丁文件一定要保证各个都是精品：补丁1用来完成一个功能点，补丁2用来完成第二个功能点，等等。一定不能出现这样的情况：补丁3用于修正补丁1的错误，补丁10改正了补丁7中的文字错误，等等。这样就带来补丁管理的难题。</p>
<p>实际上基于特性分支的开发又何尝不是如此？在将特性分支归并到开发主线前，要接受团队的评审，特性分支的开发者一定想将特性分支上的提交进行重整，把一些提交合并或者拆分。使用变基命令可以实现提交的重整，但是操作起来会比较困难，有什么好办法呢？</p>
<div class="section" id="stgit">
<h3>3.6.3.1. StGit<a class="headerlink" href="#stgit" title="永久链接至标题">¶</a></h3>
<p>Stacked Git（<a class="reference external" href="http://www.procode.org/stgit/">http://www.procode.org/stgit/</a>）简称StGit就是解决上述两个难题的答案。实际上StGit在设计上参考了一个著名的补丁管理工具Quilt，并且可以输出Quilt兼容的补丁列表。在本节的后半部分会介绍Quilt。</p>
<p>StGit是一个Python项目，安装起来还是很方便的。在Debian/Ubuntu下，可以直接通过包管理器安装：</p>
<div class="highlight-python"><div class="highlight"><pre>$ sudo aptitude install stgit stgit-contrib
</pre></div>
</div>
<p>下面还是用<tt class="docutils literal"><span class="pre">hello-world</span></tt>版本库，进行StGit的实践。</p>
<ul>
<li><p class="first">首先检出<tt class="docutils literal"><span class="pre">hello-world</span></tt>版本库。</p>
<div class="highlight-python"><div class="highlight"><pre>$ cd /path/to/my/workspace/
$ git clone file:///path/to/repos/hello-world.git stgit-demo
$ cd stgit-demo
</pre></div>
</div>
</li>
<li><p class="first">在当前工作区初始化StGit。</p>
<div class="highlight-python"><div class="highlight"><pre>$ stg init
</pre></div>
</div>
</li>
<li><p class="first">现在补丁列表为空。</p>
<div class="highlight-python"><div class="highlight"><pre>$ stg series
</pre></div>
</div>
</li>
<li><p class="first">将最新的三个提交转换为StGit补丁。</p>
<div class="highlight-python"><div class="highlight"><pre>$ stg uncommit -n 3
Uncommitting 3 patches ...
  Now at patch &quot;translate-for-chinese&quot;
done
</pre></div>
</div>
</li>
<li><p class="first">现在补丁列表中有三个文件了。</p>
<p>第一列是补丁的状态符号。加号(+)代表该补丁已经应用在版本库中，大于号(&gt;)用于标识当前的补丁。</p>
<div class="highlight-python"><div class="highlight"><pre>$ stg ser
+ fix-typo-help-to-help
+ add-i18n-support
&gt; translate-for-chinese
</pre></div>
</div>
</li>
<li><p class="first">现在查看<tt class="docutils literal"><span class="pre">master</span></tt>分支的日志，发现和之前没有两样。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git log -3 --oneline
c4acab2 Translate for Chinese.
683448a Add I18N support.
d81896e Fix typo: -help to --help.
</pre></div>
</div>
</li>
<li><p class="first">执行StGit补丁出栈的命令，会将补丁撤出应用。使用<tt class="docutils literal"><span class="pre">-a</span></tt>参数会将所有补丁撤出应用。</p>
<div class="highlight-python"><div class="highlight"><pre>$ stg pop
Popped translate-for-chinese
Now at patch &quot;add-i18n-support&quot;
$ stg pop -a
Popped add-i18n-support -- fix-typo-help-to-help
No patch applied
</pre></div>
</div>
</li>
<li><p class="first">再来看版本库的日志，会发现最新的三个提交都不见了。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git log -3 --oneline
10765a7 Bugfix: allow spaces in username.
0881ca3 Refactor: use getopt_long for arguments parsing.
ebcf6d6 blank commit for GnuPG-signed tag test.
</pre></div>
</div>
</li>
<li><p class="first">查看补丁列表的状态，会看到每个补丁前都用减号(-)标识。</p>
<div class="highlight-python"><div class="highlight"><pre>$ stg ser
- fix-typo-help-to-help
- add-i18n-support
- translate-for-chinese
</pre></div>
</div>
</li>
<li><p class="first">执行补丁入栈，即应用补丁，使用命令<strong class="command">stg push</strong>或者<strong class="command">stg goto</strong>命令，注意<strong class="command">stg push</strong>命令和<strong class="command">git push</strong>命令风马牛不相及。</p>
<div class="highlight-python"><div class="highlight"><pre>$ stg push
Pushing patch &quot;fix-typo-help-to-help&quot; ... done (unmodified)
Now at patch &quot;fix-typo-help-to-help&quot;
$ stg goto add-i18n-support
Pushing patch &quot;add-i18n-support&quot; ... done (unmodified)
Now at patch &quot;add-i18n-support&quot;
</pre></div>
</div>
</li>
<li><p class="first">现在处于应用<tt class="docutils literal"><span class="pre">add-i18n-support</span></tt>补丁的状态。这个补丁有些问题，本地化语言模板有错误，我们来修改一下。</p>
<div class="highlight-python"><div class="highlight"><pre>$ cd src/
$ rm locale/helloworld.pot
$ make po
xgettext -s -k_ -o locale/helloworld.pot main.c
msgmerge locale/zh_CN/LC_MESSAGES/helloworld.po locale/helloworld.pot -o locale/temp.po
. 完成。
mv locale/temp.po locale/zh_CN/LC_MESSAGES/helloworld.po
</pre></div>
</div>
</li>
<li><p class="first">现在查看工作区，发现工作区有改动。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git status -s
 M locale/helloworld.pot
 M locale/zh_CN/LC_MESSAGES/helloworld.po
</pre></div>
</div>
</li>
<li><p class="first">不要将改动添加暂存区，也不要提交，而是执行<strong class="command">stg refresh</strong>命令，更新补丁。</p>
<div class="highlight-python"><div class="highlight"><pre>$ stg refresh
Now at patch &quot;add-i18n-support&quot;
</pre></div>
</div>
</li>
<li><p class="first">这时再查看工作区，发现本地修改不见了。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git status -s
</pre></div>
</div>
</li>
<li><p class="first">执行<strong class="command">stg show</strong>会看到当前的补丁<tt class="docutils literal"><span class="pre">add-i18n-support</span></tt>已经更新。</p>
<div class="highlight-python"><div class="highlight"><pre>$ stg show
...
</pre></div>
</div>
</li>
<li><p class="first">将最后一个补丁应用到版本库，遇到冲突。这是因为最后一个补丁是对中文本地化文件的翻译，因为翻译前的模板文件被更改了所以造成了冲突。</p>
<div class="highlight-python"><div class="highlight"><pre>$ stg push
Pushing patch &quot;translate-for-chinese&quot; ... done (conflict)
Error: 1 merge conflict(s)
       CONFLICT (content): Merge conflict in
       src/locale/zh_CN/LC_MESSAGES/helloworld.po
Now at patch &quot;translate-for-chinese&quot;
</pre></div>
</div>
</li>
<li><p class="first">这个冲突文件很好解决，直接编辑冲突文件<tt class="file docutils literal"><span class="pre">helloworld.po</span></tt>即可。编辑好之后，注意一下第50行和第62行是否像下面写的一样。</p>
<div class="highlight-python"><div class="highlight"><pre>50 &quot;    hello -h, --help\n&quot;
51 &quot;            显示本帮助页。\n&quot;
...
61 msgid &quot;Hi,&quot;
62 msgstr &quot;您好,&quot;
</pre></div>
</div>
</li>
<li><p class="first">执行<strong class="command">git add</strong>命令完成冲突解决。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git add locale/zh_CN/LC_MESSAGES/helloworld.po
</pre></div>
</div>
</li>
<li><p class="first">不要提交，而是使用<strong class="command">stg refresh</strong>命令更新补丁，同时更新提交。</p>
<div class="highlight-python"><div class="highlight"><pre>$ stg refresh
Now at patch &quot;translate-for-chinese&quot;
$ git status -s
</pre></div>
</div>
</li>
<li><p class="first">看看修改后的程序，是不是都能显示中文了。</p>
<div class="highlight-python"><div class="highlight"><pre>$ ./hello
世界你好。
(version: v1.0-5-g733c6ea)
$ ./hello Jiang Xin
您好, Jiang Xin.
(version: v1.0-5-g733c6ea)
$ ./hello -h
...
</pre></div>
</div>
</li>
<li><p class="first">导出补丁，使用命令<strong class="command">stg export</strong>。导出的是Quilt格式的补丁集。</p>
<div class="highlight-python"><div class="highlight"><pre>$ cd /path/to/my/workspace/stgit-demo/
$ stg export -d patches
Checking for changes in the working directory ... done
</pre></div>
</div>
</li>
<li><p class="first">看看导出补丁的目标目录。</p>
<div class="highlight-python"><div class="highlight"><pre>$ ls patches/
add-i18n-support  fix-typo-help-to-help  series  translate-for-chinese
</pre></div>
</div>
</li>
<li><p class="first">其中文件<tt class="file docutils literal"><span class="pre">series</span></tt>是补丁文件的列表，列在前面的补丁先被应用。</p>
<div class="highlight-python"><div class="highlight"><pre>$ cat patches/series
# This series applies on GIT commit d81896e60673771ef1873b27a33f52df75f70515
fix-typo-help-to-help
add-i18n-support
translate-for-chinese
</pre></div>
</div>
</li>
</ul>
<p>通过上面的演示可以看出StGit可以非常方便的对提交进行整理，整理提交时无需使用复杂的变基命令，而是采用：提交StGit化，修改文件，执行<strong class="command">stg refresh</strong>的工作流程即可更新补丁和提交。StGit还可以将补丁导出为补丁文件，虽然导出的补丁文件没有像<strong class="command">git format-patch</strong>那样加上代表顺序的数字前缀，但是用文件<tt class="file docutils literal"><span class="pre">series</span></tt>标注了补丁文件的先后顺序。实际上可以在执行<strong class="command">stg export</strong>时添加<tt class="docutils literal"><span class="pre">-n</span></tt>参数为补丁文件添加数字前缀。</p>
<p>StGit还有一些功能，如合并补丁/提交，插入新补丁/提交等，请参照StGit帮助，恕不一一举例。</p>
</div>
<div class="section" id="quilt">
<h3>3.6.3.2. Quilt<a class="headerlink" href="#quilt" title="永久链接至标题">¶</a></h3>
<p>Quilt是一款补丁列表管理软件，用Shell语言开发，安装也很简单，在Debian/Ubuntu上直接用下面的命令即可安装：</p>
<div class="highlight-python"><div class="highlight"><pre>$ sudo aptitude install quilt
</pre></div>
</div>
<p>Quilt约定俗成将补丁集放在项目根目录下的子目录<tt class="file docutils literal"><span class="pre">patches</span></tt>中，否则需要通过环境变量<tt class="docutils literal"><span class="pre">QUILT_PATCHES</span></tt>对路径进行设置。为了减少麻烦，在上面用<strong class="command">stg export</strong>导出补丁的时候就导出到了<tt class="file docutils literal"><span class="pre">patches</span></tt>目录下。</p>
<p>简单说一下Quilt的使用，会发现真的和StGit很像，实际上是先有的Quilt，后有的StGit。</p>
<ul>
<li><p class="first">重置到三个提交前的版本，否则应用补丁的时候会失败。还不要忘了删除<tt class="file docutils literal"><span class="pre">src/locale</span></tt>目录。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git reset --hard HEAD~3
$ rm -rf src/locale/
</pre></div>
</div>
</li>
<li><p class="first">显示补丁列表</p>
<div class="highlight-python"><div class="highlight"><pre>$ quilt series
01-fix-typo-help-to-help
02-add-i18n-support
03-translate-for-chinese
</pre></div>
</div>
</li>
<li><p class="first">应用一个补丁。</p>
<div class="highlight-python"><div class="highlight"><pre>$ quilt push
Applying patch 01-fix-typo-help-to-help
patching file src/main.c

Now at patch 01-fix-typo-help-to-help
</pre></div>
</div>
</li>
<li><p class="first">下一个补丁是什么？</p>
<div class="highlight-python"><div class="highlight"><pre>$ quilt next
02-add-i18n-support
</pre></div>
</div>
</li>
<li><p class="first">应用全部补丁。</p>
<div class="highlight-python"><div class="highlight"><pre>$ quilt push -a
Applying patch 02-add-i18n-support
patching file src/Makefile
patching file src/locale/helloworld.pot
patching file src/locale/zh_CN/LC_MESSAGES/helloworld.po
patching file src/main.c

Applying patch 03-translate-for-chinese
patching file src/locale/zh_CN/LC_MESSAGES/helloworld.po

Now at patch 03-translate-for-chinese
</pre></div>
</div>
</li>
</ul>
<p>Quilt的功能还有很多，请参照Quilt的联机帮助，恕不一一举例。</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="总目录"
             >索引</a></li>
        <li class="right" >
          <a href="../04-git-model/index.html" title="4. Git协同模型"
             >下一页</a> |</li>
        <li class="right" >
          <a href="050-git-remote.html" title="3.5. 远程版本库"
             >上一页</a> |</li>
        <li><a href="../index.html">GotGit</a> &raquo;</li>
          <li><a href="index.html" >3. Git和声</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/"><img alt="知识共享许可协议" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" /></a>
      <br />
      全部内容以 <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Creative Commons 署名-非商业性使用-相同方式共享 3.0 协议发布</a>.
      <br />
        &copy; Copyright 2011, 蒋鑫。
      使用 <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2.3 创建。

    </div>
  </body>
</html>