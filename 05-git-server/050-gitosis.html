
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>5.5. Gitosis服务架设 &mdash; GotGit</title>
    
    <link rel="stylesheet" href="../static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="/stylesheets/master.css" type="text/css" />
    <link rel="stylesheet" href="/stylesheets/syntax.css" type="text/css" />
    <link rel="stylesheet" href="../static/worldhello.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../static/jquery.js"></script>
    <script type="text/javascript" src="../static/underscore.js"></script>
    <script type="text/javascript" src="../static/doctools.js"></script>
    <script type="text/javascript" src="../static/translations.js"></script>
    <link rel="top" title="GotGit" href="../index.html" />
    <link rel="up" title="5. 搭建Git服务器" href="index.html" />
    <link rel="next" title="5.6. Gerrit代码审核服务器" href="055-gerrit.html" />
    <link rel="prev" title="5.4. Gitolite服务架设" href="040-gitolite.html" /> 
  </head>
  <body>
    <div id='header'>
      <h1><a href='/'>World Hello</a></h1>

      <div id='menu'>
        <ul>
          <li><a href='/' id='home-link' title='Home'>首页</a></li>
          <li><a href='/blog.html' id='blog-link' title='Blog'>博客</a></li>
          <li><a href='/doc/' id='docs-link' title='Docs'>文章</a></li>
          <li><a href='/about.html' id='about-link' title='About'>关于</a></li>
          <li><a href='http://github.com/gotgit' target='_blank' title='GitHub' rel='me' id='github-link'>GitHub</a></li>
          <li><a href='http://weibo.com/gotgit' title='微博' target='_blank' id='weibo-link'>微博</a></li>
        </ul>
      </div>
    </div>

    <div class="related">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="总目录"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="055-gerrit.html" title="5.6. Gerrit代码审核服务器"
             accesskey="N">下一页</a> |</li>
        <li class="right" >
          <a href="040-gitolite.html" title="5.4. Gitolite服务架设"
             accesskey="P">上一页</a> |</li>
        <li><a href="../index.html">GotGit</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">5. 搭建Git服务器</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">內容目录</a></h3>
  <ul>
<li><a class="reference internal" href="#">5.5. Gitosis服务架设</a><ul>
<li><a class="reference internal" href="#id1">5.5.1. 安装Gitosis</a><ul>
<li><a class="reference internal" href="#id2">5.5.1.1. Gitosis的安装</a></li>
<li><a class="reference internal" href="#id3">5.5.1.2. 服务器端创建专用帐号</a></li>
<li><a class="reference internal" href="#id4">5.5.1.3. Gitosis服务初始化</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id5">5.5.2. 管理Gitosis</a><ul>
<li><a class="reference internal" href="#gitolit-admin">5.5.2.1. 管理员克隆<tt class="docutils literal"><span class="pre">gitolit-admin</span></tt>管理库</a></li>
<li><a class="reference internal" href="#id6">5.5.2.2. 增加新用户</a></li>
<li><a class="reference internal" href="#id7">5.5.2.3. 更改授权</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id8">5.5.3. Gitosis授权详解</a><ul>
<li><a class="reference internal" href="#id9">5.5.3.1. Gitosis缺省设置</a></li>
<li><a class="reference internal" href="#gitosis-admin">5.5.3.2. 管理版本库<tt class="docutils literal"><span class="pre">gitosis-admin</span></tt></a></li>
<li><a class="reference internal" href="#id10">5.5.3.3. 定义用户组和授权</a></li>
<li><a class="reference internal" href="#gitweb">5.5.3.4. Gitweb整合</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id11">5.5.4. 创建新版本库</a></li>
<li><a class="reference internal" href="#git">5.5.5. 轻量级管理的Git服务</a></li>
</ul>
</li>
</ul>

  <h4>上一个主题</h4>
  <p class="topless"><a href="040-gitolite.html"
                        title="上一章">5.4. Gitolite服务架设</a></p>
  <h4>下一个主题</h4>
  <p class="topless"><a href="055-gerrit.html"
                        title="下一章">5.6. Gerrit代码审核服务器</a></p>
  <h3>本页</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/05-git-server/050-gitosis.txt"
           rel="nofollow">显示源代码</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>快速搜索</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="转向" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    输入相关的术语，模块，类或者函数名称进行搜索
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="gitosis">
<h1>5.5. Gitosis服务架设<a class="headerlink" href="#gitosis" title="永久链接至标题">¶</a></h1>
<p>Gitosis是Gitolite的鼻祖，同样也是一款基于SSH公钥认证的Git服务管理工具，但是功能要比之前介绍的Gitolite要弱的多。Gitosis由Python语言开发，对于偏爱Python不喜欢Perl的开发者（我就是其中之一），可以对Gitosis加以关注。</p>
<p>Gitosis的出现远早于Gitolite，作者Tommi Virtanen从2007年5月就开始了gitosis的开发，最后一次提交是在2009年9月，已经停止更新了。但是Gitosis依然有其生命力。</p>
<ul>
<li><p class="first">配置简洁，可以直接在服务器端编辑，成为为某些服务定制的内置的无需管理的Git服务。</p>
<p>Gitosis的配置文件非常简单，直接保存于服务安装用户（如<tt class="docutils literal"><span class="pre">git</span></tt>）的主目录下<tt class="file docutils literal"><span class="pre">.gitosis.conf</span></tt>文件中，可以直接在服务器端创建和编辑。</p>
<p>Gitolite的授权文件需要复杂的编译，因此一般需要管理员克隆<tt class="docutils literal"><span class="pre">gitolite-admin</span></tt>库，远程编辑并推送至服务器。因此用Gitolite实现一个无需管理的Git服务难度要大很多。</p>
</li>
<li><p class="first">支持版本库重定向。</p>
<p>版本库重定向一方面在版本库路径变更后保持旧的URL仍可工作，另一方面用在客户端用简洁的地址屏蔽服务器端复杂的地址。</p>
<p>例如我开发的一款备份工具（Gistore），版本库位于<tt class="file docutils literal"><span class="pre">/etc/gistore/tasks/system/repo.git</span></tt>（符号链接），客户端使用<tt class="docutils literal"><span class="pre">system.git</span></tt>即映射到复杂的服务器端地址。</p>
<p>这个功能我已经在定制的Gitolite中实现。</p>
</li>
<li><p class="first">Python语言开发，对于喜欢Python，不喜欢Perl的用户，可以选择Gitosis。</p>
</li>
<li><p class="first">在Github上有很多Gitosis的克隆，我对gitosis的改动放在了github上：</p>
<p><a class="reference external" href="http://github.com/ossxp-com/gitosis">http://github.com/ossxp-com/gitosis</a></p>
</li>
</ul>
<p>Gitosis因为是Gitolite的鼻祖，因此下面的Gitosis实现机理，似曾相识：</p>
<ul>
<li><p class="first">Gitosis安装在服务器（<tt class="docutils literal"><span class="pre">server.name</span></tt>）某个帐号之下，例如<tt class="docutils literal"><span class="pre">git</span></tt>帐号。</p>
</li>
<li><p class="first">管理员通过Git命令检出名为<tt class="docutils literal"><span class="pre">gitosis-admin</span></tt>的版本库。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git clone git@server.name:gitosis-admin.git
</pre></div>
</div>
</li>
<li><p class="first">管理员将git用户的公钥保存在<tt class="docutils literal"><span class="pre">gitosis-admin</span></tt>库的<tt class="file docutils literal"><span class="pre">keydir</span></tt>目录下，并编辑<tt class="file docutils literal"><span class="pre">gitosis.conf</span></tt>文件为用户授权。</p>
</li>
<li><p class="first">当管理员对<tt class="docutils literal"><span class="pre">gitosis-admin</span></tt>库的修改提交并PUSH到服务器之后，服务器上<tt class="docutils literal"><span class="pre">gitosis-admin</span></tt>版本库的钩子脚本将执行相应的设置工作。</p>
<ul>
<li><p class="first">新用户公钥自动追加到服务器端安装帐号的<tt class="file docutils literal"><span class="pre">.ssh/authorized_keys</span></tt>中，并设置该用户的shell为gitosis的一条命令<strong class="command">gitosis-serve</strong>。</p>
<div class="highlight-python"><div class="highlight"><pre>command=&quot;gitosis-serve jiangxin&quot;,no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty ssh-rsa &lt;公钥内容来自于 jiangxin.pub ...&gt;
</pre></div>
</div>
</li>
<li><p class="first">更新服务器端的授权文件<tt class="file docutils literal"><span class="pre">~/.gitosis.conf</span></tt>。</p>
</li>
</ul>
</li>
<li><p class="first">用户可以用Git命令访问授权的版本库。</p>
</li>
<li><p class="first">当管理员授权，用户可以远程在服务器上创建新版本库。</p>
</li>
</ul>
<p>下面介绍Gitosis的部署和使用。在下面的示例中，约定：服务器的名称为<tt class="docutils literal"><span class="pre">server</span></tt>，Gitolite的安装帐号为<tt class="docutils literal"><span class="pre">git</span></tt>。</p>
<div class="section" id="id1">
<h2>5.5.1. 安装Gitosis<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<p>Gitosis的部署和使用可以直接参考源代码中的<tt class="file docutils literal"><span class="pre">README.rst</span></tt>。可以直接访问Github上我的gitosis克隆，因为Github能够直接将rst文件显示为网页。</p>
<p>参考:</p>
<div class="highlight-python"><div class="highlight"><pre>http://github.com/ossxp-com/gitosis/blob/master/README.rst
</pre></div>
</div>
<div class="section" id="id2">
<h3>5.5.1.1. Gitosis的安装<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h3>
<p>Gitosis安装需要在服务器端执行。下面介绍直接从源代码进行安装，以便获得最新的改进。</p>
<p>Gitosis的官方Git库位于<tt class="docutils literal"><span class="pre">git://eagain.net/gitosis.git</span></tt>。我在Github上创建了一个分支：</p>
<blockquote>
<div><a class="reference external" href="http://github.com/ossxp-com/gitosis">http://github.com/ossxp-com/gitosis</a></div></blockquote>
<ul>
<li><p class="first">使用git下载Gitosis的源代码。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git clone git://github.com/ossxp-com/gitosis.git
</pre></div>
</div>
</li>
<li><p class="first">进入 <tt class="file docutils literal"><span class="pre">gitosis</span></tt>目录，执行安装。</p>
<div class="highlight-python"><div class="highlight"><pre>$ cd gitosis
$ sudo python setup.py install
</pre></div>
</div>
</li>
<li><p class="first">可执行脚本安装在<tt class="file docutils literal"><span class="pre">/usr/local/bin</span></tt>目录下。</p>
<div class="highlight-python"><div class="highlight"><pre>$ ls /usr/local/bin/gitosis-*
/usr/local/bin/gitosis-init  /usr/local/bin/gitosis-run-hook  /usr/local/bin/gitosis-serve
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="id3">
<h3>5.5.1.2. 服务器端创建专用帐号<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h3>
<p>安装Gitosis，还需要在服务器端创建专用帐号，所有用户都通过此帐号访问Git库。一般为方便易记，选择git作为专用帐号名称。</p>
<div class="highlight-python"><div class="highlight"><pre>$ sudo adduser --system --shell /bin/bash --disabled-password --group it
</pre></div>
</div>
<p>创建用户<tt class="docutils literal"><span class="pre">git</span></tt>，并设置用户的shell为可登录的shell，如<tt class="docutils literal"><span class="pre">/bin/bash</span></tt>，同时添加同名的用户组。</p>
<p>有的系统，只允许特定的用户组（如<tt class="docutils literal"><span class="pre">ssh</span></tt>用户组）的用户才可以通过SSH协议登录，这就需要将新建的<tt class="docutils literal"><span class="pre">git</span></tt>用户添加到<tt class="docutils literal"><span class="pre">ssh</span></tt>用户组中。</p>
<div class="highlight-python"><div class="highlight"><pre>$ sudo adduser git ssh
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h3>5.5.1.3. Gitosis服务初始化<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h3>
<p>Gitosis服务初始化，就是初始化一个<tt class="docutils literal"><span class="pre">gitosis-admin</span></tt>库，并为管理员分配权限，还要将Gitosis管理员的公钥添加到专用帐号的<tt class="file docutils literal"><span class="pre">~/.ssh/authorized_keys</span></tt>文件中。</p>
<ul>
<li><p class="first">如果管理员在客户端没有公钥，使用下面命令创建。</p>
<div class="highlight-python"><div class="highlight"><pre>$ ssh-keygen
</pre></div>
</div>
</li>
<li><p class="first">管理员上传公钥到服务器。</p>
<div class="highlight-python"><div class="highlight"><pre>$ scp ~/.ssh/id_rsa.pub server:/tmp
</pre></div>
</div>
</li>
<li><p class="first">服务器端进行Gitosis服务初始化。</p>
<p>以git用户身份执行<tt class="docutils literal"><span class="pre">gitosis-init</span></tt>命令，并向其提供管理员公钥。</p>
<div class="highlight-python"><div class="highlight"><pre>$ sudo su - git
$ gitosis-init &lt; /tmp/id_rsa.pub
</pre></div>
</div>
</li>
<li><p class="first">确保<tt class="docutils literal"><span class="pre">gitosis-admin</span></tt>版本库的钩子脚本可执行。</p>
<div class="highlight-python"><div class="highlight"><pre>$ sudo chmod a+x ~git/repositories/gitosis-admin.git/hooks/post-update
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<div class="section" id="id5">
<h2>5.5.2. 管理Gitosis<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h2>
<div class="section" id="gitolit-admin">
<h3>5.5.2.1. 管理员克隆<tt class="docutils literal"><span class="pre">gitolit-admin</span></tt>管理库<a class="headerlink" href="#gitolit-admin" title="永久链接至标题">¶</a></h3>
<p>当Gitosis安装完成后，在服务器端自动创建了一个用于Gitosis自身管理的Git库：<tt class="docutils literal"><span class="pre">gitosis-admin.git</span></tt>。</p>
<p>管理员在客户端克隆<tt class="docutils literal"><span class="pre">gitosis-admin.git</span></tt>库，注意要确保认证中使用正确的公钥：</p>
<div class="highlight-python"><div class="highlight"><pre>$ git clone git@server:gitosis-admin.git
$ cd gitosis-admin/

$ ls -F
gitosis.conf  keydir/

$ ls keydir/
jiangxin.pub
</pre></div>
</div>
<p>可以看出<tt class="docutils literal"><span class="pre">gitosis-admin</span></tt>目录下有一个陪孩子文件和一个目录<tt class="file docutils literal"><span class="pre">keydir</span></tt>。</p>
<ul>
<li><p class="first"><tt class="file docutils literal"><span class="pre">keydir/jiangxin.pub</span></tt>文件</p>
<p><tt class="file docutils literal"><span class="pre">keydir</span></tt>目录下初始时只有一个用户公钥，即管理员的公钥。管理员的用户名来自公钥文件末尾的用户名。</p>
</li>
<li><p class="first"><tt class="file docutils literal"><span class="pre">gitosis.conf</span></tt>文件</p>
<p>该文件为授权文件。初始内容为:</p>
<div class="highlight-python"><div class="highlight"><pre>1  [gitosis]
2
3  [group gitosis-admin]
4  writable = gitosis-admin
5  members = jiangxin
</pre></div>
</div>
<p>可以看到授权文件的语法完全不同于之前介绍的Gitolite的授权文件。整个授权文件是以用户组为核心，而非版本库为核心。</p>
<ul>
<li><p class="first">定义了一个用户组<tt class="docutils literal"><span class="pre">gitosis-admin</span></tt>。</p>
<p>第3行开始定义了一个用户组<tt class="docutils literal"><span class="pre">gitosis-admin</span></tt>。</p>
</li>
<li><p class="first">第5行设定了该用户组包含的用户列表。</p>
<p>初始时只有一个用户，即管理员公钥所属的用户。</p>
</li>
<li><p class="first">第4行设定了该用户组对那些版本库具有写操作。</p>
<p>这里配置对<tt class="docutils literal"><span class="pre">gitosis-admin</span></tt>版本库具有写操作。写操作自动包含了读操作。</p>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id6">
<h3>5.5.2.2. 增加新用户<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h3>
<p>增加新用户，就是允许新用户能够通过其公钥访问Git服务。只要将新用户的公钥添加到<tt class="docutils literal"><span class="pre">gitosis-admin</span></tt>版本库的<tt class="file docutils literal"><span class="pre">keydir</span></tt>目录下，即完成新用户的添加。</p>
<ul>
<li><p class="first">管理员从用户获取公钥，并将公钥按照<tt class="file docutils literal"><span class="pre">username.pub</span></tt>格式进行重命名。</p>
<p>用户可以通过邮件或者其他方式将公钥传递给管理员，切记不要将私钥误传给管
理员。如果发生私钥泄漏，马上重新生成新的公钥/私钥对，并将新的公钥传递给管理员，并申请将旧的公钥作废。</p>
<p>关于公钥名称，我引入了类似Gitolite的实现：</p>
<ul class="simple">
<li>用户从不同的客户端主机访问有着不同的公钥，如果希望使用同一个用户名进行授权，可以按照<tt class="docutils literal"><span class="pre">username&#64;host.pub</span></tt>方式命名公钥文件，和名为<tt class="docutils literal"><span class="pre">username&#64;pub</span></tt>的公钥指向同一个用户<tt class="docutils literal"><span class="pre">username</span></tt>。</li>
<li>也支持邮件地址格式的公钥，即形如<tt class="docutils literal"><span class="pre">username&#64;gmail.com.pub</span></tt>的公钥。Gitosis能够很智能的区分是以邮件地址命名的公钥还是相同用户在不同主机上的公钥。如果是邮件地址命名的公钥，将以整个邮件地址作为用户名。</li>
</ul>
</li>
<li><p class="first">管理员进入<tt class="docutils literal"><span class="pre">gitosis-admin</span></tt>本地克隆版本库中，复制新用户公钥到<tt class="file docutils literal"><span class="pre">keydir</span></tt>目录。</p>
<div class="highlight-python"><div class="highlight"><pre>$ cp /path/to/dev1.pub keydir/
$ cp /path/to/dev2.pub keydir/
</pre></div>
</div>
</li>
<li><p class="first">执行<strong class="command">git add</strong>命令，将公钥添加入版本库。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git add keydir
$ git status
# On branch master
# Changes to be committed:
#   (use &quot;git reset HEAD &lt;file&gt;...&quot; to unstage)
#
#       new file:   keydir/dev1.pub
#       new file:   keydir/dev2.pub
#
</pre></div>
</div>
</li>
<li><p class="first">执行<strong class="command">git commit</strong>，完成提交。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git commit -m &quot;add user: dev1, dev2&quot;
[master d7952a5] add user: dev1, dev2
 2 files changed, 2 insertions(+), 0 deletions(-)
 create mode 100644 keydir/dev1.pub
 create mode 100644 keydir/dev2.pub
</pre></div>
</div>
</li>
<li><p class="first">执行<strong class="command">git push</strong>，同步到服务器，才真正完成新用户的添加。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git push
Counting objects: 7, done.
Delta compression using up to 2 threads.
Compressing objects: 100% (5/5), done.
Writing objects: 100% (5/5), 1.03 KiB, done.
Total 5 (delta 0), reused 0 (delta 0)
To git@server:gitosis-admin.git
   2482e1b..d7952a5  master -&gt; master
</pre></div>
</div>
</li>
</ul>
<p>如果这时查看服务器端<tt class="file docutils literal"><span class="pre">~git/.ssh/authorized_keys</span></tt>文件，会发现新增的用户公钥也附加其中：</p>
<div class="highlight-python"><div class="highlight"><pre>### autogenerated by gitosis, DO NOT EDIT
command=&quot;gitosis-serve jiangxin&quot;,no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty     &lt;用户jiangxin的公钥...&gt;
command=&quot;gitosis-serve dev1&quot;,no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty ssh-rsa &lt;用户 dev1 的公钥...&gt;
command=&quot;gitosis-serve dev2&quot;,no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty ssh-rsa &lt;用户 dev1 的公钥...&gt;
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h3>5.5.2.3. 更改授权<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h3>
<p>新用户添加完毕，可能需要重新进行授权。更改授权的方法也非常简单，即修改<tt class="file docutils literal"><span class="pre">gitosis.conf</span></tt>配置文件，提交并推送。</p>
<p>首先管理员进入<tt class="docutils literal"><span class="pre">gitosis-admin</span></tt>本地克隆版本库中，编辑<tt class="file docutils literal"><span class="pre">gitosis.conf</span></tt>。</p>
<div class="highlight-python"><div class="highlight"><pre>$ vi gitosis.conf
</pre></div>
</div>
<p>授权指令比较复杂，先通过建立一个新用户组并授权新版本库<tt class="docutils literal"><span class="pre">testing</span></tt>尝试一下更改授权文件。例如在<tt class="file docutils literal"><span class="pre">gitosis.conf</span></tt>中添加如下授权内容：</p>
<div class="highlight-python"><div class="highlight"><pre>1   [group testing-admin]
2   members = jiangxin @gitosis-admin
3   admin = testing
4
5   [group testing-devloper]
6   members = dev1 dev2
7   writable = testing
8
9   [group testing-reader]
10  members = @all
11  readonly = testing
</pre></div>
</div>
<ul>
<li><p class="first">上面的授权文件为版本库<tt class="docutils literal"><span class="pre">testing</span></tt>赋予了三个角色。分别是<tt class="docutils literal"><span class="pre">&#64;testing-admin</span></tt>用户组，<tt class="docutils literal"><span class="pre">&#64;testing-developer</span></tt>用户组和<tt class="docutils literal"><span class="pre">&#64;testing-reader</span></tt>用户组。</p>
</li>
<li><p class="first">第1行开始的<tt class="docutils literal"><span class="pre">testing-admin</span></tt>小节，定义了用户组<tt class="docutils literal"><span class="pre">&#64;testing-admin</span></tt>。</p>
</li>
<li><p class="first">第2行设定该用户组包含的用户有<tt class="docutils literal"><span class="pre">jiangxin</span></tt>，以及前面定义的<tt class="docutils literal"><span class="pre">&#64;gitosis-admin</span></tt>用户组用户。</p>
</li>
<li><p class="first">第3行用<tt class="docutils literal"><span class="pre">admin</span></tt>指令，设定该用户组用户可以创建版本库<tt class="docutils literal"><span class="pre">testing</span></tt>。</p>
<p><tt class="docutils literal"><span class="pre">admin</span></tt>指令是笔者新增的授权指令，请确认安装的Gitosis包含笔者的改进。</p>
</li>
<li><p class="first">第7行用<tt class="docutils literal"><span class="pre">writable</span></tt>授权指令，设定该<tt class="docutils literal"><span class="pre">&#64;testing-developer</span></tt>用户组用户可以读写版本库<tt class="docutils literal"><span class="pre">testing</span></tt>。</p>
<p>笔者改进后的Gitosis也可以使用<tt class="docutils literal"><span class="pre">write</span></tt>作为<tt class="docutils literal"><span class="pre">writable</span></tt>指令的同义词指令。</p>
</li>
<li><p class="first">第11行用<tt class="docutils literal"><span class="pre">readonly</span></tt>授权指令，设定该<tt class="docutils literal"><span class="pre">&#64;testing-reader</span></tt>用户组用户（所有用户）可以只读访问版本库<tt class="docutils literal"><span class="pre">testing</span></tt>。</p>
<p>笔者改进后的Gitosis也可以使用<tt class="docutils literal"><span class="pre">read</span></tt>作为<tt class="docutils literal"><span class="pre">readonly</span></tt>指令的同义词指令。</p>
</li>
</ul>
<p>编辑结束，提交改动。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git add gitosis.conf
$ git commit -q -m &quot;auth for repo testing.&quot;
</pre></div>
</div>
<p>执行<strong class="command">git push</strong>，同步到服务器，才真正完成授权文件的编辑。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git push
</pre></div>
</div>
</div>
</div>
<div class="section" id="id8">
<h2>5.5.3. Gitosis授权详解<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h2>
<div class="section" id="id9">
<h3>5.5.3.1. Gitosis缺省设置<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h3>
<p>在<tt class="docutils literal"><span class="pre">[gitosis]</span></tt>小节中定义Gitosis的缺省设置。如下：</p>
<div class="highlight-python"><div class="highlight"><pre>1  [gitosis]
2  repositories = /gitroot
3  #loglevel=DEBUG
4  gitweb = yes
5  daemon = yes
6  generate-files-in = /home/git/gitosis
</pre></div>
</div>
<p>其中：</p>
<ul>
<li><p class="first">第2行，设置版本库缺省的根目录是<tt class="file docutils literal"><span class="pre">/gitroot</span></tt>目录。</p>
<p>否则缺省路径是安装用户主目录下的<tt class="file docutils literal"><span class="pre">repositories</span></tt>目录。</p>
</li>
<li><p class="first">第3行，如果打开注释，则版本库操作时显示Gitosis调试信息。</p>
</li>
<li><p class="first">第4行，启用gitweb的整合。</p>
<p>可以通过<tt class="docutils literal"><span class="pre">[repo</span> <span class="pre">name]</span></tt>小节为版本库设置描述字段，用户显示在Gitweb中。</p>
</li>
<li><p class="first">第5行，启用git-daemon的整合。</p>
<p>即新创建的版本库中，创建文件<tt class="file docutils literal"><span class="pre">git-daemon-export-ok</span></tt>。</p>
</li>
<li><p class="first">第6行，设置创建的项目列表文件（供gitweb使用）所在的目录。</p>
<p>缺省即为安装用户的主目录下的<tt class="file docutils literal"><span class="pre">gitosis</span></tt>目录。</p>
</li>
</ul>
</div>
<div class="section" id="gitosis-admin">
<h3>5.5.3.2. 管理版本库<tt class="docutils literal"><span class="pre">gitosis-admin</span></tt><a class="headerlink" href="#gitosis-admin" title="永久链接至标题">¶</a></h3>
<div class="highlight-python"><div class="highlight"><pre>1  [group gitosis-admin]
2  write = gitosis-admin
3  members = jiangxin
4  repositories = /home/git
</pre></div>
</div>
<p>除了第4行，其他内容在前面都已经介绍过了，是Gitosis自身管理版本库的用户组设置。</p>
<p>第4行，重新设置了版本库的缺省根路经，覆盖缺省的<tt class="docutils literal"><span class="pre">[gitosis]</span></tt>小节中的缺省根路径。实际的<tt class="docutils literal"><span class="pre">gitosis-admin</span></tt>版本库的路径为<tt class="file docutils literal"><span class="pre">/home/git/gitosis-admin.git</span></tt>。</p>
</div>
<div class="section" id="id10">
<h3>5.5.3.3. 定义用户组和授权<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h3>
<p>下面的两个示例小节定义了两个用户组，并且用到了路径变换的指令。</p>
<div class="highlight-python"><div class="highlight"><pre>1   [group ossxp-admin]
2   members = @gitosis-admin jiangxin
3   admin = ossxp/**
4   read = gistore/*
5   map admin redmine-* = ossxp/redmine/\1
6   map admin ossxp/redmine-* = ossxp/(redmine-.*):ossxp/redmine/\1
7   map admin ossxp/testlink-* = ossxp/(testlink-.*):ossxp/testlink/\1
8   map admin ossxp/docbones* = ossxp/(docbones.*):ossxp/docutils/\1
9
10  [group all]
11  read = ossxp/**
12  map read redmine-* = ossxp/redmine/\1
13  map read testlink-* = ossxp/testlink/\1
14  map read pysvnmanager-gitsvn = mirrors/pysvnmanager-gitsvn
15  map read ossxp/redmine-* = ossxp/(redmine-.*):ossxp/redmine/\1
16  map read ossxp/testlink-* = ossxp/(testlink-.*):ossxp/testlink/\1
17  map read ossxp/docbones* = ossxp/(docbones.*):ossxp/docutils/\1
18  repositories = /gitroot
</pre></div>
</div>
<p>在上面的示例中，演示了授权指令以及Gitosis特色的<tt class="docutils literal"><span class="pre">map</span></tt>指令。</p>
<ul>
<li><p class="first">第1行，定义了用户组<tt class="docutils literal"><span class="pre">&#64;ossxp-admin</span></tt>。</p>
</li>
<li><p class="first">第2行，设定该用户组包含用户<tt class="docutils literal"><span class="pre">jiangxin</span></tt>以及用户组<tt class="docutils literal"><span class="pre">&#64;gitosis-admin</span></tt>的所有用户。</p>
</li>
<li><p class="first">第3行，设定该用户组具有创建及读写与通配符<tt class="docutils literal"><span class="pre">ossxp/**</span></tt>匹配的版本库。</p>
<p>两个星号匹配任意字符包括路径分隔符（/）。此功能属于笔者扩展的功能。</p>
</li>
<li><p class="first">第4行，设定该用户组可以只读访问<tt class="docutils literal"><span class="pre">gistore/*</span></tt>匹配的版本库。</p>
<p>一个星号匹配任意字符包括路径分隔符（/）。 此功能也属于笔者扩展的功能。</p>
</li>
<li><p class="first">第5行，是Gitosis特有的版本库名称重定位功能。</p>
<p>即对<tt class="docutils literal"><span class="pre">redmine-*</span></tt>匹配的版本库，先经过名称重定位，在名称前面加上<tt class="docutils literal"><span class="pre">ossxp/remdine</span></tt>。其中<tt class="docutils literal"><span class="pre">\\1</span></tt>代表匹配的整个版本库名称。</p>
<p>用户组<tt class="docutils literal"><span class="pre">&#64;ossxp-admin</span></tt>的用户对于重定位后的版本库，具有<tt class="docutils literal"><span class="pre">admin</span></tt>（创建和读写）权限。</p>
</li>
<li><p class="first">第6行，是我扩展的版本库名称重定位功能，支持正则表达式。</p>
<p>等号左边的名称进行通配符匹配，匹配后，再经过右侧的一对正则表达式进行转换（冒号前的用于匹配，冒号后的用于替换）。</p>
</li>
<li><p class="first">第10行，使用了内置的<tt class="docutils literal"><span class="pre">&#64;all</span></tt>用户组，因此不需要通过<tt class="docutils literal"><span class="pre">members</span></tt>设定用户，因为所有用户均属于该用户组。</p>
</li>
<li><p class="first">第11行，设定所有用户均可以只读访问<tt class="docutils literal"><span class="pre">ossxp/**</span></tt>匹配的版本库。</p>
</li>
<li><p class="first">第12-17行，对特定路径进行映射，并分配只读权限。</p>
</li>
<li><p class="first">第18行，设置版本库的根路径为<tt class="file docutils literal"><span class="pre">/gitroot</span></tt>，而非缺省的版本库根路径。</p>
</li>
</ul>
</div>
<div class="section" id="gitweb">
<h3>5.5.3.4. Gitweb整合<a class="headerlink" href="#gitweb" title="永久链接至标题">¶</a></h3>
<p>Gitosis和Gitweb的整合，提供了两个方面的内容。一个是可以设置版本库的描述信息，用于在gitweb的项目列表页面显示。另外一个是自动生成项目的列表文件供Gitweb参考，避免Gitweb使用效率低的目录递归搜索查找Git版本库列表。</p>
<p>例如在<tt class="file docutils literal"><span class="pre">gitosis.conf</span></tt>中下面的配置用于对<tt class="docutils literal"><span class="pre">redmine-1.0.x</span></tt>版本库的Gitweb整合进行设置。</p>
<div class="highlight-python"><div class="highlight"><pre>1  [repo ossxp/redmine/redmine-1.0.x]
2  gitweb = yes
3  owner = Jiang Xin
4  description = Redmine 1.0.x 群英汇定制开发
</pre></div>
</div>
<ul>
<li><p class="first">第1行，<tt class="docutils literal"><span class="pre">repo</span></tt>小节用于设置版本库的Gitweb整合。</p>
<p>版本库的实际路径是用版本库缺省的根（即在<tt class="docutils literal"><span class="pre">[gitosis]</span></tt>小节中定义的或者缺省的）加上此小节中的版本库路径组合而成的。</p>
</li>
<li><p class="first">第2行，启用Gitweb整合。如果省略，使用全局<tt class="docutils literal"><span class="pre">[gitosis]</span></tt>小节中gitweb的设置。</p>
</li>
<li><p class="first">第3行，用于设置版本库的属主。</p>
</li>
<li><p class="first">第4行，用于设置版本库的描述信息，显示在Gitweb的版本库列表中。</p>
</li>
</ul>
<p>每一个<tt class="docutils literal"><span class="pre">repo</span></tt>小节所指向的版本库，如果启用了Gitweb选项，则版本库名称汇总到一个项目列表文件中。该项目列表文件缺省保存在<tt class="file docutils literal"><span class="pre">~/gitosis/projects.list</span></tt>中。</p>
</div>
</div>
<div class="section" id="id11">
<h2>5.5.4. 创建新版本库<a class="headerlink" href="#id11" title="永久链接至标题">¶</a></h2>
<p>Gitosis维护的版本库位于安装用户主目录下的<tt class="file docutils literal"><span class="pre">repositories</span></tt>目录中，即如果安装用户为<tt class="docutils literal"><span class="pre">git</span></tt>，则版本库都创建在<tt class="file docutils literal"><span class="pre">/home/git/repositories</span></tt>目录之下。可以通过配置文件<tt class="file docutils literal"><span class="pre">gitosis.conf</span></tt>修改缺省的版本库的根路径。</p>
<p>可以直接在服务器端创建，或者在客户端远程创建版本库。</p>
<p><strong>克隆即创建，还是PUSH即创建？</strong></p>
<p>在客户端远程创建版本库时，Gitosis的原始实现是对版本库具有<tt class="docutils literal"><span class="pre">writable</span></tt>（读写）权限的用户，对不存在的版本库执行克隆操作时，自动创建。但是我认为这不是一个好的实践，会经常因为克隆的URL写错，导致在服务器端创建垃圾版本库。笔者改进的实现如下：</p>
<ul class="simple">
<li>增加了名为<tt class="docutils literal"><span class="pre">admin</span></tt>（或<tt class="docutils literal"><span class="pre">init</span></tt>）的授权指令，只有具有此授权的用户，才能够创建版本库。</li>
<li>只具有<tt class="docutils literal"><span class="pre">writable</span></tt>（或<tt class="docutils literal"><span class="pre">write</span></tt>）权限的用户，不能在服务器上创建版本库。</li>
<li>不通过克隆创建版本库，而是在对版本库进行PUSH的时候进行创建。当克隆一个不存在的版本库，会报错退出。</li>
</ul>
<p>远程在服务器上创建版本库的方法如下：</p>
<ul>
<li><p class="first">首先，本地建库。</p>
<div class="highlight-python"><div class="highlight"><pre>$ mkdir somerepo
$ cd somerepo
$ git init
$ git commit --allow-empty
</pre></div>
</div>
</li>
<li><p class="first">使用<strong class="command">git remote</strong>指令添加远程的源。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git remote add origin git@server:ossxp/somerepo.git
</pre></div>
</div>
</li>
<li><p class="first">运行<strong class="command">git push</strong>完成在服务器端版本库的创建</p>
<div class="highlight-python"><div class="highlight"><pre>$ git push origin master
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="git">
<h2>5.5.5. 轻量级管理的Git服务<a class="headerlink" href="#git" title="永久链接至标题">¶</a></h2>
<p>轻量级管理的含义是不采用缺省的稍显复杂的管理模式（远程克隆<tt class="docutils literal"><span class="pre">gitosis-admin</span></tt>库，修改并PUSH的管理模式），而是直接在服务器端通过预先定制的配置文件提供Git服务。这种轻量级管理模式，对于为某些应用建立快速的Git库服务提供了便利。</p>
<p>例如在使用备份工具Gistore进行文件备份时，可以用Gitosis架设轻量级的Git服务，可以在远程使用Git命令进行双机甚至是异地备份。</p>
<p>首先创建一个专用帐号，并设置该用户只能执行<strong class="command">gitosis-serve</strong>命令。例如创建帐号<tt class="docutils literal"><span class="pre">gistore</span></tt>，通过修改<strong class="command">/etc/ssh/sshd_config</strong>配置文件，实现限制该帐号登录的可执行命令。</p>
<div class="highlight-python"><div class="highlight"><pre>Match user gistore
    ForceCommand gitosis-serve gistore
    X11Forwarding no
    AllowTcpForwarding no
    AllowAgentForwarding no
    PubkeyAuthentication yes
    #PasswordAuthentication no
</pre></div>
</div>
<p>上述配置信息告诉SSH服务器，凡是以<tt class="docutils literal"><span class="pre">gistore</span></tt>用户登录的帐号，强制执行Gitosis的命令。</p>
<p>然后，在该用户的主目录下创建一个配置文件<tt class="file docutils literal"><span class="pre">.gitosis.conf</span></tt>（注意文件名前面的点号），如下：</p>
<div class="highlight-python"><div class="highlight"><pre>[gitosis]
repositories = /etc/gistore/tasks
gitweb = yes
daemon = no

[group gistore]
members = gistore
map readonly * = (.*):\1/repo
</pre></div>
</div>
<p>上述配置的含义是：</p>
<ul class="simple">
<li>用户<tt class="docutils literal"><span class="pre">gistore</span></tt>才能够访问<tt class="file docutils literal"><span class="pre">/etc/gistore/tasks</span></tt>下的Git库。</li>
<li>版本库的名称要经过变换，例如<tt class="docutils literal"><span class="pre">system</span></tt>库会变换为实际路径<tt class="file docutils literal"><span class="pre">/etc/gistore/tasks/system/repo.git</span></tt>。</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="总目录"
             >索引</a></li>
        <li class="right" >
          <a href="055-gerrit.html" title="5.6. Gerrit代码审核服务器"
             >下一页</a> |</li>
        <li class="right" >
          <a href="040-gitolite.html" title="5.4. Gitolite服务架设"
             >上一页</a> |</li>
        <li><a href="../index.html">GotGit</a> &raquo;</li>
          <li><a href="index.html" >5. 搭建Git服务器</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/"><img alt="知识共享许可协议" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" /></a>
      <br />
      全部内容以 <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Creative Commons 署名-非商业性使用-相同方式共享 3.0 协议发布</a>.
      <br />
        &copy; Copyright 2011, 蒋鑫。
      使用 <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2.3 创建。

    </div>
  </body>
</html>