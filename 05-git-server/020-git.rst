使用 Git 协议
**************

Git 协议是提供 Git 版本库只读服务的最为常用的协议，也是非常易用和易于配置的协议。该协议的缺点就是不能提供身份认证，而且一般也不提供写入服务。

Git 协议语法格式
================

Git 协议的语法格式如下。

::

  语法： git://<server>[:<port>]/path/to/repos.git/


说明：

* 端口为可选项，默认端口为 9418。
* 版本库路径 `/path/to/repos.git` 的根目录并不一定是系统的根目录，可以在 `git-daemon` 启动时用参数 `--base-path` 指定根目录。如果 `git-daemon` 没有设置根目录，则对应于系统的根目录。

Git 服务软件
=============

Git 服务由名为 git-daemon 的服务软件提供。虽然 git-daemon 也可以支持写操作，但因为 git-daemon 没有提供认证支持，因此没有人胆敢配置 git-daemon 提供匿名的写服务。使用 git-daemon 提供的 Git 版本库的只读服务，效率很高，而且是一种智能协议，在操作过程有进度显示，远比 HTTP 哑通讯协议方便（Git 1.6.6 之后的版本已经支持智能 HTTP 通讯协议）。因此 git-daemon 很久一来，一直是 Git 版本库只读服务的首选。

Git 软件包本身提供了 git-daemon，因此只要安装了 Git，一般就已经安装了 git-daemon。默认 git-daemon 并没有运行，需要对其进行配置以服务方式运行。下面介绍两种不同的配置运行方式。

以 inetd 方式配置运行
=====================

最简单的方式，是以 inetd 服务方式运行 git-daemon。在配置文件 `/etc/inetd.conf` 中添加设置如下:

::

  git stream tcp nowait nobody  /usr/bin/git
      git daemon --inetd --verbose --export-all
      /gitroot/foo /gitroot/bar

说明：

* 以 `nobody` 用户身份执行 git daemon 服务。

* 缺省 git daemon 只对包含文件 `git-daemon-export-ok` 的版本库提供服务。使用参数 `--export-all` 后，无论版本库是否存在标识文件 `git-daemon-export-ok` ，都对版本库提供 git 访问服务。

* 后面的两个参数是版本库。

  也可以通过 `--base-path=<path>` 参数，设置版本库的根，对于这个目录下的所有版本库提供访问服务。例如下面的 inetd 配置：

  ::

    git stream tcp nowait nobody  /usr/bin/git
        git daemon --inetd --verbose --export-all
        --base-path=/var/cache /var/cache/git

以 runit 方式配置运行
======================

runit 是类似于 sysvinit 的服务管理进程，但是更简单。在 Debian/Ubuntu 上的软件包 `git-daemon-run` 就是基于 runit 启动 git-daemon 服务。

* 安装 `git-daemon-run` ：

  ::

    $ sudo aptitude install git-daemon-run

* 配置 `git-daemon-run` ：

  缺省的服务配置文件： `/etc/sv/git-daemon/run` 。和之前的 inetd 运行方式相比，以独立的服务进程启动，相应速度更快。

  ::

    #!/bin/sh
    exec 2>&1
    echo 'git-daemon starting.'
    exec chpst -ugitdaemon \
      "$(git --exec-path)"/git-daemon --verbose --export-all --base-path=/var/cache /var/cache/git


缺省版本库中需要存在文件 `git-daemon-export-ok` ，git-daemon 才对此版本库提供服务。不过可以通过启动 git-daemon 时提供的参数 `--export-all` ，无论版本库是否存在标识文件 `git-daemon-export-ok` ，都对版本库提供 git 访问服务。

通过 git-daemon 提供的 Git 访问协议存在着局限性：

* 不支持认证。管理员大概可以做的只是配置防火墙，限制某个网段用户的使用。
* 只能提供匿名的版本库读取服务。因为写操作没有授权控制，因此一般不用来提供写操作。

