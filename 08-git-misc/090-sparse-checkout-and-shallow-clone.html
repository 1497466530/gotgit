
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>8.2.3. 稀疏检出和浅克隆 &mdash; GotGit</title>
    
    <link rel="stylesheet" href="../static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="/stylesheets/master.css" type="text/css" />
    <link rel="stylesheet" href="/stylesheets/syntax.css" type="text/css" />
    <link rel="stylesheet" href="../static/worldhello.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../static/jquery.js"></script>
    <script type="text/javascript" src="../static/underscore.js"></script>
    <script type="text/javascript" src="../static/doctools.js"></script>
    <script type="text/javascript" src="../static/translations.js"></script>
    <link rel="top" title="GotGit" href="../index.html" />
    <link rel="up" title="8.2. Git 的其他特性" href="050-git-features.html" />
    <link rel="next" title="8.2.4. 嫁接和替换" href="110-graft-and-replace.html" />
    <link rel="prev" title="8.2.2. 钩子和模板" href="070-hooks-and-templates.html" /> 
  </head>
  <body>
    <div id='header'>
      <h1><a href='/'>World Hello</a></h1>

      <div id='menu'>
        <ul>
          <li><a href='/' id='home-link' title='Home'>首页</a></li>
          <li><a href='/blog.html' id='blog-link' title='Blog'>博客</a></li>
          <li><a href='/doc/' id='docs-link' title='Docs'>文章</a></li>
          <li><a href='/about.html' id='about-link' title='About'>关于</a></li>
          <li><a href='http://github.com/gotgit' target='_blank' title='GitHub' rel='me' id='github-link'>GitHub</a></li>
          <li><a href='http://weibo.com/gotgit' title='微博' target='_blank' id='weibo-link'>微博</a></li>
        </ul>
      </div>
    </div>

    <div class="related">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="总目录"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="110-graft-and-replace.html" title="8.2.4. 嫁接和替换"
             accesskey="N">下一页</a> |</li>
        <li class="right" >
          <a href="070-hooks-and-templates.html" title="8.2.2. 钩子和模板"
             accesskey="P">上一页</a> |</li>
        <li><a href="../index.html">GotGit</a> &raquo;</li>
          <li><a href="index.html" >8. Git杂谈</a> &raquo;</li>
          <li><a href="050-git-features.html" accesskey="U">8.2. Git 的其他特性</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">內容目录</a></h3>
  <ul>
<li><a class="reference internal" href="#">8.2.3. 稀疏检出和浅克隆</a><ul>
<li><a class="reference internal" href="#id2">8.2.3.1. 稀疏检出</a></li>
<li><a class="reference internal" href="#id3">8.2.3.2. 浅克隆</a></li>
</ul>
</li>
</ul>

  <h4>上一个主题</h4>
  <p class="topless"><a href="070-hooks-and-templates.html"
                        title="上一章">8.2.2. 钩子和模板</a></p>
  <h4>下一个主题</h4>
  <p class="topless"><a href="110-graft-and-replace.html"
                        title="下一章">8.2.4. 嫁接和替换</a></p>
  <h3>本页</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/08-git-misc/090-sparse-checkout-and-shallow-clone.txt"
           rel="nofollow">显示源代码</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>快速搜索</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="转向" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    输入相关的术语，模块，类或者函数名称进行搜索
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="id1">
<h1>8.2.3. 稀疏检出和浅克隆<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h1>
<div class="section" id="id2">
<h2>8.2.3.1. 稀疏检出<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<p>从1.7.0版本开始Git提供稀疏检出的功能。所谓稀疏检出就是本地版本库检出时不检出全部，只将指定的文件从本地版本库检出到工作区，而其他未指定的文件则不予检出（即使这些文件存在于工作区，其修改也会被忽略）。</p>
<p>要想实现稀疏检出的功能，必须同时设置<tt class="docutils literal"><span class="pre">core.sparseCheckout</span></tt>配置变量，并存在文件<tt class="file docutils literal"><span class="pre">.git/info/sparse-checkout</span></tt>。即首先要设置Git配置变量<tt class="docutils literal"><span class="pre">core.sparseCheckout</span></tt>为<tt class="docutils literal"><span class="pre">true</span></tt>，然后编辑<tt class="file docutils literal"><span class="pre">.git/info/sparse-checkout</span></tt>文件，将要检出的目录或文件的路径写入其中。其中文件<tt class="file docutils literal"><span class="pre">.git/info/sparse-checkout</span></tt>的格式就和<tt class="file docutils literal"><span class="pre">.gitignore</span></tt>文件格式一样，路径可以使用通配符。</p>
<p>稀疏检出是如何实现的呢？实际上Git在index（即暂存区）中为每个文件提供一个名为<tt class="docutils literal"><span class="pre">skip-worktree</span></tt>标志位，缺省这个标识位处于关闭状态。如果该标识位开启，则无论工作区对应的文件存在与否，或者是否被修改，Git都认为工作区该文件的版本是最新的、无变化。Git通过配置文件<tt class="file docutils literal"><span class="pre">.git/info/sparse-checkout</span></tt>定义一个要检出的目录和/或文件列表，当前Git的<strong class="command">git read-tree</strong>命令及其他基于合并的命令（<strong class="command">git merge</strong>，<strong class="command">git checkout</strong>等等）能够根据该配置文件更新index中文件的<tt class="docutils literal"><span class="pre">skip-worktree</span></tt>标志位，实现版本库文件的稀疏检出。</p>
<p>先来在工作区<tt class="file docutils literal"><span class="pre">/path/to/my/workspace</span></tt>中创建一个示例版本库sparse1，创建后的sparse1版本库中包含如下内容：</p>
<div class="highlight-python"><div class="highlight"><pre>$ ls -F
doc1/ doc2/ doc3/
$ git ls-files -s -v
H 100644 ce013625030ba8dba906f756967f9e9ca394464a 0     doc1/readme.txt
H 100644 ce013625030ba8dba906f756967f9e9ca394464a 0     doc2/readme.txt
H 100644 ce013625030ba8dba906f756967f9e9ca394464a 0     doc3/readme.txt
</pre></div>
</div>
<p>即版本库sparse1中包含三个目录<tt class="file docutils literal"><span class="pre">doc1</span></tt>、<tt class="file docutils literal"><span class="pre">doc2</span></tt>和<tt class="file docutils literal"><span class="pre">doc3</span></tt>。命令<strong class="command">git ls-files</strong>的<tt class="docutils literal"><span class="pre">-s</span></tt>参数用于显示对象的SHA1哈希值以及所处的暂存区编号。而<tt class="docutils literal"><span class="pre">-v</span></tt>参数则还会显示工作区文件的状态，每一行命令输出的第一个字符即是文件状态：字母<tt class="docutils literal"><span class="pre">H</span></tt>表示文件已被暂存，如果是字母<tt class="docutils literal"><span class="pre">S</span></tt>则表示该文件<tt class="docutils literal"><span class="pre">skip-worktree</span></tt>标志位已开启。</p>
<p>下面我们就来体验一下稀疏检出的功能。</p>
<ul>
<li><p class="first">修改版本库的Git配置变量<tt class="docutils literal"><span class="pre">core.sparseCheckout</span></tt>，将其设置为<tt class="docutils literal"><span class="pre">true</span></tt>。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git config core.sparseCheckout true
</pre></div>
</div>
</li>
<li><p class="first">设置<tt class="file docutils literal"><span class="pre">.git/info/sparse-checkout</span></tt>的内容，如下：</p>
<div class="highlight-python"><div class="highlight"><pre>$ printf &quot;doc1\ndoc3\n&quot; &gt; .git/info/sparse-checkout
$ cat .git/info/sparse-checkout
doc1
doc3
</pre></div>
</div>
</li>
<li><p class="first">执行<strong class="command">git checkout</strong>命令后，会发现工作区中<tt class="file docutils literal"><span class="pre">doc2</span></tt>目录不见了。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git checkout
$ ls -F
doc1/ doc3/
</pre></div>
</div>
</li>
<li><p class="first">这时如果用<strong class="command">git ls-files</strong>命令查看，会发现<tt class="file docutils literal"><span class="pre">doc2</span></tt>目录下的文件被设置了<tt class="docutils literal"><span class="pre">skip-worktree</span></tt>标志。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git ls-files -v
H doc1/readme.txt
S doc2/readme.txt
H doc3/readme.txt
</pre></div>
</div>
</li>
<li><p class="first">修改<tt class="file docutils literal"><span class="pre">.git/info/sparse-checkout</span></tt>的内容，如下：</p>
<div class="highlight-python"><div class="highlight"><pre>$ printf &quot;doc3\n&quot; &gt; .git/info/sparse-checkout
$ cat .git/info/sparse-checkout
doc3
</pre></div>
</div>
</li>
<li><p class="first">执行<strong class="command">git checkout</strong>命令后，会发现工作区中<tt class="file docutils literal"><span class="pre">doc1</span></tt>目录也不见了。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git checkout
$ ls -F
doc3/
</pre></div>
</div>
</li>
<li><p class="first">这时如果用<strong class="command">git ls-files</strong>命令查看，会发现<tt class="file docutils literal"><span class="pre">doc1</span></tt>和<tt class="file docutils literal"><span class="pre">doc2</span></tt>目录下的文件都被设置了<tt class="docutils literal"><span class="pre">skip-worktree</span></tt>标志。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git ls-files -v
S doc1/readme.txt
S doc2/readme.txt
H doc3/readme.txt
</pre></div>
</div>
</li>
<li><p class="first">修改<tt class="file docutils literal"><span class="pre">.git/info/sparse-checkout</span></tt>的内容，使之包含一个星号，即在工作区检出所有的内容。</p>
<div class="highlight-python"><div class="highlight"><pre>$ printf &quot;*\n&quot; &gt; .git/info/sparse-checkout
$ cat .git/info/sparse-checkout
*
</pre></div>
</div>
</li>
<li><p class="first">执行<strong class="command">git checkout</strong>，会发现所有目录又都回来了。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git checkout
$ ls -F
doc1/ doc2/ doc3/
</pre></div>
</div>
</li>
</ul>
<p>文件<tt class="file docutils literal"><span class="pre">.git/info/sparse-checkout</span></tt>的文件格式类似于<tt class="file docutils literal"><span class="pre">.gitignore</span></tt>的格式，也支持用感叹号实现反向操作。例如不检出目录<tt class="file docutils literal"><span class="pre">doc2</span></tt>下的文件，而检出其他文件，可以使用下面的语法（注意顺序不能写反）：</p>
<div class="highlight-python"><div class="highlight"><pre>*
!doc2/
</pre></div>
</div>
<p>注意如果使用命令<strong class="command">git checkout &#8211; &lt;file&gt;...</strong>，即不是切换分支而是用分支中的文件替换暂存区和工作区的话，则忽略<tt class="docutils literal"><span class="pre">skip-worktree</span></tt>标志。例如下面的操作中，虽然<tt class="file docutils literal"><span class="pre">doc2</span></tt>被设置为不检出，但是执行<strong class="command">git checkout .</strong>命令后，还是所有的目录都被检出了。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git checkout .
$ ls -F
doc1/ doc2/ doc3/
$ git ls-files -v
H doc1/readme.txt
S doc2/readme.txt
H doc3/readme.txt
</pre></div>
</div>
<p>如果修改<tt class="file docutils literal"><span class="pre">doc2</span></tt>目录下的文件，或者在<tt class="file docutils literal"><span class="pre">doc2</span></tt>目录下添加新文件，Git会视而不见。</p>
<div class="highlight-python"><div class="highlight"><pre>$ echo hello &gt;&gt; doc2/readme.txt
$ git status
# On branch master
nothing to commit (working directory clean)
</pre></div>
</div>
<p>若此时通过取消<tt class="docutils literal"><span class="pre">core.sparseCheckout</span></tt>配置变量的设置而关闭稀疏检出，也不会改变目录<tt class="file docutils literal"><span class="pre">doc2</span></tt>下的文件的<tt class="docutils literal"><span class="pre">skip-worktree</span></tt>标志。这种情况或者通过<strong class="command">git update-index &#8211;no-skip-worktree &#8211; &lt;file&gt;...</strong>来更改index中对应文件的<tt class="docutils literal"><span class="pre">skip-worktree</span></tt>标志，或者重新启用稀疏检出更改相应文件的检出状态。</p>
<p>在克隆一个版本库时只希望检出部分文件或目录，可以在执行克隆操作的时候使用<tt class="docutils literal"><span class="pre">--no-checkout</span></tt>或<tt class="docutils literal"><span class="pre">-n</span></tt>参数，不进行工作区文件的检出。例如下面的操作从前面示例的sparse1版本库克隆到sparse2中，不进行工作区文件的检出。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git clone -n sparse1 sparse2
Cloning into sparse2...
done.
</pre></div>
</div>
<p>检出完成后可以发现sparse2的工作区是空的，而且版本库中也不存在<tt class="file docutils literal"><span class="pre">index</span></tt>文件。如果执行<strong class="command">git status</strong>命令会看到所有文件都被标识为删除。</p>
<div class="highlight-python"><div class="highlight"><pre>$ cd sparse2
$ git status -s
D  doc1/readme.txt
D  doc2/readme.txt
D  doc3/readme.txt
</pre></div>
</div>
<p>如果希望通过稀疏检出的功能，只检出其中一个目录如<tt class="file docutils literal"><span class="pre">doc2</span></tt>，可以用如下方法实现：</p>
<div class="highlight-python"><div class="highlight"><pre>$ git config core.sparseCheckout true
$ printf &quot;doc2\n&quot; &gt; .git/info/sparse-checkout
$ git checkout
</pre></div>
</div>
<p>之后看到工作区中检出了<tt class="file docutils literal"><span class="pre">doc2</span></tt>目录，而其他文件被设置了<tt class="docutils literal"><span class="pre">skip-worktree</span></tt>标志。</p>
<div class="highlight-python"><div class="highlight"><pre>$ ls -F
doc2/
$ git ls-files -v
S doc1/readme.txt
H doc2/readme.txt
S doc3/readme.txt
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h2>8.2.3.2. 浅克隆<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<p>上一节介绍的稀疏检出，可以部分检出版本库中的文件，但是版本库本身仍然包含所有的文件和历史。如果只对一个大的版本库的最近的部分历史提交感兴趣，而不想克隆整个版本库，稀疏检出是解决不了的，而是要采用本节介绍的浅克隆。</p>
<p>实现版本库的浅克隆的非常简单，只需要在执行<strong class="command">git clone</strong>或者<strong class="command">git fetch</strong>操作时用<tt class="docutils literal"><span class="pre">--depth</span> <span class="pre">&lt;depth&gt;</span></tt>参数设定要获取的历史提交的深度（<tt class="docutils literal"><span class="pre">&lt;depth&gt;</span></tt>大于0），就会把源版本库分支上最近的<tt class="docutils literal"><span class="pre">&lt;depth&gt;</span> <span class="pre">+</span> <span class="pre">1</span></tt>个历史提交作为新版本库的全部历史提交。</p>
<p>通过浅克隆方式克隆出来的版本库，每一个提交的SHA1哈希值和源版本库的相同，包括提交的根节点也是如次，但是Git通过特殊的实现，使得浅克隆的根节点提交看起来没有父提交。正因为浅克隆的提交对象的SHA1哈希值和源版本库一致，所以浅克隆版本库可以执行<strong class="command">git fetch</strong>或者<strong class="command">git pull</strong>从源版本库获取新的提交。但是浅克隆版本库也存在着很多限制，如：</p>
<ul class="simple">
<li>不能从浅克隆版本库克隆出新的版本库。</li>
<li>其他版本库不能从浅克隆获取提交。</li>
<li>其他版本库不能推送提交到浅克隆版本库。</li>
<li>不要从浅克隆版本库推送提交至其他版本库，除非确认推送的目标版本库包含浅克隆版本库中缺失的全部历史提交，否则会造成目标版本库包含不完整的提交历史导致版本库无法操作。</li>
<li>在浅克隆版本库中执行合并操作时，如果所合并的提交出现在浅克隆历史中，则可以顺利合并，否则会出现大量的冲突，就好像和无关的历史进行合并一样。</li>
</ul>
<p>由于浅克隆包含上述限制，因此浅克隆一般用于对远程版本库的查看和研究，如果在浅克隆版本库中进行了提交，最好通过<strong class="command">git format-patch</strong>命令导出为补丁文件再应用到远程版本库中。</p>
<p>下面的操作使用<strong class="command">git clone</strong>命令创建一个浅克隆。注意：源版本库如果是本地版本库要使用<tt class="docutils literal"><span class="pre">file://</span></tt>协议，若直接接使用本地路径则不会实现浅克隆。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git clone --depth 2 file:///path/to/repos/hello-world.git shallow1
</pre></div>
</div>
<p>然后进入到本地克隆目录中，会看到当前分支上只有3个提交。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git log  --oneline
c4acab2 Translate for Chinese.
683448a Add I18N support.
d81896e Fix typo: -help to --help.
</pre></div>
</div>
<p>查看提交的根节点<tt class="docutils literal"><span class="pre">d81896e</span></tt>，则会看到该提交实际上也包含父提交。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git cat-file -p HEAD^^
tree f9d7f6b0af6f3fffa74eb995f1d781d3c4876b25
parent 10765a7ef46981a73d578466669f6e17b73ac7e3
author user1 &lt;user1@sun.ossxp.com&gt; 1294069736 +0800
committer user2 &lt;user2@moon.ossxp.com&gt; 1294591238 +0800

Fix typo: -help to --help.
</pre></div>
</div>
<p>而查看该提交的父提交，Git会报错。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git log 10765a7ef46981a73d578466669f6e17b73ac7e3
fatal: bad object 10765a7ef46981a73d578466669f6e17b73ac7e3
</pre></div>
</div>
<p>对于正常的Git版本库来说，如果对象库中一个提交丢失绝对是大问题，版本库不可能被正常使用。而浅克隆之所以看起来一切正常，是因为Git使用了类似嫁接（下一节即将介绍）的技术。</p>
<p>在浅克隆版本库中存在一个文件<tt class="file docutils literal"><span class="pre">.git/shallow</span></tt>，这个文件中罗列了应该被视为提交根节点的提交SHA1哈希值。查看这个文件会看到提交<tt class="docutils literal"><span class="pre">d81896e</span></tt>正在其中：</p>
<div class="highlight-python"><div class="highlight"><pre>$ cat .git/shallow
b56bb510a947651e4717b356587945151ac32166
d81896e60673771ef1873b27a33f52df75f70515
e64f3a216d346669b85807ffcfb23a21f9c5c187
</pre></div>
</div>
<p>列在<tt class="file docutils literal"><span class="pre">.git/shallow</span></tt>文件中的提交会构建出对应的嫁接提交，使用类似嫁接文件<tt class="file docutils literal"><span class="pre">.git/info/grafts</span></tt>（下节讨论）的机制，当Git访问这些对象时就好像这些对象是没有父提交的根节点一样。</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="总目录"
             >索引</a></li>
        <li class="right" >
          <a href="110-graft-and-replace.html" title="8.2.4. 嫁接和替换"
             >下一页</a> |</li>
        <li class="right" >
          <a href="070-hooks-and-templates.html" title="8.2.2. 钩子和模板"
             >上一页</a> |</li>
        <li><a href="../index.html">GotGit</a> &raquo;</li>
          <li><a href="index.html" >8. Git杂谈</a> &raquo;</li>
          <li><a href="050-git-features.html" >8.2. Git 的其他特性</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/"><img alt="知识共享许可协议" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" /></a>
      <br />
      全部内容以 <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Creative Commons 署名-非商业性使用-相同方式共享 3.0 协议发布</a>.
      <br />
        &copy; Copyright 2011, 蒋鑫。
      使用 <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2.3 创建。

    </div>
  </body>
</html>