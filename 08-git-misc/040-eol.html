
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>8.1.3. 换行符问题 &mdash; GotGit</title>
    
    <link rel="stylesheet" href="../static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="/stylesheets/master.css" type="text/css" />
    <link rel="stylesheet" href="/stylesheets/syntax.css" type="text/css" />
    <link rel="stylesheet" href="../static/worldhello.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../static/jquery.js"></script>
    <script type="text/javascript" src="../static/underscore.js"></script>
    <script type="text/javascript" src="../static/doctools.js"></script>
    <script type="text/javascript" src="../static/translations.js"></script>
    <link rel="top" title="GotGit" href="../index.html" />
    <link rel="up" title="8.1. 跨平台操作Git" href="010-git-cross-os.html" />
    <link rel="next" title="8.2. Git 的其他特性" href="050-git-features.html" />
    <link rel="prev" title="8.1.2. 文件名大小写问题" href="030-case-insensitive.html" /> 
  </head>
  <body>
    <div id='header'>
      <h1><a href='/'>World Hello</a></h1>

      <div id='menu'>
        <ul>
          <li><a href='/' id='home-link' title='Home'>首页</a></li>
          <li><a href='/blog.html' id='blog-link' title='Blog'>博客</a></li>
          <li><a href='/doc/' id='docs-link' title='Docs'>文章</a></li>
          <li><a href='/about.html' id='about-link' title='About'>关于</a></li>
          <li><a href='http://github.com/gotgit' target='_blank' title='GitHub' rel='me' id='github-link'>GitHub</a></li>
          <li><a href='http://weibo.com/gotgit' title='微博' target='_blank' id='weibo-link'>微博</a></li>
        </ul>
      </div>
    </div>

    <div class="related">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="总目录"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="050-git-features.html" title="8.2. Git 的其他特性"
             accesskey="N">下一页</a> |</li>
        <li class="right" >
          <a href="030-case-insensitive.html" title="8.1.2. 文件名大小写问题"
             accesskey="P">上一页</a> |</li>
        <li><a href="../index.html">GotGit</a> &raquo;</li>
          <li><a href="index.html" >8. Git杂谈</a> &raquo;</li>
          <li><a href="010-git-cross-os.html" accesskey="U">8.1. 跨平台操作Git</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h4>上一个主题</h4>
  <p class="topless"><a href="030-case-insensitive.html"
                        title="上一章">8.1.2. 文件名大小写问题</a></p>
  <h4>下一个主题</h4>
  <p class="topless"><a href="050-git-features.html"
                        title="下一章">8.2. Git 的其他特性</a></p>
  <h3>本页</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/08-git-misc/040-eol.txt"
           rel="nofollow">显示源代码</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>快速搜索</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="转向" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    输入相关的术语，模块，类或者函数名称进行搜索
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="id1">
<h1>8.1.3. 换行符问题<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h1>
<p>每一个通用的版本控制系统，无论是CVS、Subversion、Git或是其他，都要面对换行符转换的问题。这是因为作为通用的版本控制系统要面对来自不同操作系统的文件，而不同的操作系统在处理文本文件时，可能使用不同的换行符。</p>
<p><strong>不同的操作系统可能使用不同的换行符</strong></p>
<p>文本文件的每一行结尾用一个或者两个特殊的ASCII字符进行标识，这个标识就是换行符。主要的换行符有三种：LF（Line Feed即换行，C语言等用“<tt class="docutils literal"><span class="pre">\\n</span></tt>”表示，相当于十六进制的<tt class="docutils literal"><span class="pre">0x0A</span></tt>），CR（Carriage Return 即回车，C语言等用“<tt class="docutils literal"><span class="pre">\\r</span></tt>”表示，相当于十六进制的<tt class="docutils literal"><span class="pre">0x0D</span></tt>）和CRLF（即由两个字符“CR+LF”组成，即“<tt class="docutils literal"><span class="pre">\\r\\n</span></tt>”，相当于十六进制的<tt class="docutils literal"><span class="pre">0x0D</span> <span class="pre">0x0A</span></tt>），分别用在不同的操作系统中。（以下内容摘自<a class="reference external" href="http://en.wikipedia.org/wiki/Newline">http://en.wikipedia.org/wiki/Newline</a>。）</p>
<ul class="simple">
<li>LF换行符：用于Multics、Unix、类Unix（如GNU/Linux、AIX、Xenix、Mac OS X、FreeBSD等）、BeOS、Amiga、RISC OS等操作系统中。</li>
<li>CRLF换行符：用于DEC TOPS-10、RT-11和其他早期的非Unix，以及CP/M、MP/M、DOS（MS-DOS、PC-DOS等）、Atari TOS、OS/2、Microsoft Windows、Symbian OS、Palm OS等系统中。</li>
<li>CR换行符：用于Commodore 8位机、TRS-80、苹果II家族、Mac OS 9及更早版本。</li>
</ul>
<p>实际上，自从苹果的Mac OS从第10版转向Unix内核开始，依据不同的文本文件换行符，主流的操作系统可以划分为两大阵营，一个是微软Windows作为一方，使用CRLF作为换行符，另外一方包括Unix、类Unix（如Linux和Mac OS X等）使用LF作为换行符。分属不同阵营的操作系统之间交换文本文件会因为换行符的不同造成障碍，而对于使用版本控制系统，也同样会遇到换行符的麻烦。</p>
<ul class="simple">
<li>编辑器不能识别换行符，可能会显示为特殊字符，如Linux上的编辑器显示的<tt class="docutils literal"><span class="pre">^M</span></tt>特殊字符，就是拜Windows的CRLF换行符所赐。或者丢弃换行符，如来自Linux的文本文件，在Windows上打开可能会因为识别不了换行符，导致所有的行合并。</li>
<li>版本库中的文件被来自不同操作系统的用户改来改去，在某一次提交中换行符为LF，在下一次提交中被替换为CRLF，这不但会在查看文件版本间差异时造成困惑（所有的行都显示为变更），还给版本库的存储带来不必要的冗余。</li>
<li>可能会在一个文件中引入混杂的换行符，即有的行是LF，而有的行是CRLF。无论在那个操作系统用编辑器打开这样的文件，都会或多或少感到困惑。</li>
<li>如果版本控制系统提供文本文件换行符的自动转换，在Windows平台进行版本库文件导出为源码包并发布，当该源码包被Linux用户下载，编译、运行可能会有问题，反之亦然。</li>
</ul>
<p><strong>文本文件和二进制文件的判别，是换行符转换的基础</strong></p>
<p>几乎所有的版本库控制系统都采用这样的解决方案：对于<strong>文本文件</strong>，在版本库中保存时换行符使用LF，当从版本库检出到工作区时，则根据平台的不同或者用户的设置的不同，对文本文件的换行符进行转换（转换为LF、CR或CRLF）。</p>
<p>为什么换行符转换要特意强调文本文件呢？这是因为如果对二进制文件（程序或者数据）当中出现的换行符进行上述转换，会导致二进制文件被破坏。因此判别文件类型是文本文件还是二进制文件，是正确进行文件换行符转换的基础。</p>
<p>有的版本控制系统，如CVS，必须在添加文件时人为的设定文件类型（用<tt class="docutils literal"><span class="pre">-kb</span></tt>参数设定二进制文件），一旦用户忘记对二进制文件进行标记，就会造成二进制文件被破坏。这种破坏有时藏的比较深，例如在Linux上检出文件一切正常，因为版本库中被误判为文本文件的图形文件中所包含字符<tt class="docutils literal"><span class="pre">0x0A</span></tt>在Linux上检出没有改变，但是在Windows上检出会导致图形文件中的<tt class="docutils literal"><span class="pre">0x0A</span></tt>字符被转换为<tt class="docutils literal"><span class="pre">0x0D</span> <span class="pre">0x0A</span></tt>两个字符，造成图片被破坏。</p>
<p>有的版本控制系统可以自动识别文本文件和二进制文件，但是识别算法存在问题。例如Subversion检查文件的前1024字节的内容，如果其中包含NULL字符（<tt class="docutils literal"><span class="pre">0x00</span></tt>），或者超过15%是非ASCII字符，则Subversion认定此文件为二进制文件（参见Subversion源代码<tt class="file docutils literal"><span class="pre">subversion/libsvn_subr/io.c</span></tt>中的<tt class="docutils literal"><span class="pre">svn_io_detect_mimetype2</span></tt>函数）。这种算法会将包含大量中文的文本文件当作二进制文件，不进行换行符转换，也不能进行版本间的比较（除非强制执行）。</p>
<p>Git显然比Subversion更了解这个世界上文字的多样性，因此在判别二进制文件上没有多余的判别步骤，只对blob对象的前8000个字符进行检查，如果其中出现NULL字符（<tt class="docutils literal"><span class="pre">0x00</span></tt>）则当作二进制文件，否则为文本文件（参见Git源代码<tt class="file docutils literal"><span class="pre">xdiff-interface.c</span></tt>中的<tt class="docutils literal"><span class="pre">buffer_is_binary</span></tt>函数）。Git还允许用户通过属性文件对文件类型进行设置，属性文件设置优先。</p>
<p>Git缺省并不开启文本文件的换行符转换，因为毕竟Git对文件是否是二进制文件所做的猜测存在误判的可能。如果用户通过属性文件或者其他方式显式的对文件类型进行了设置，则Git就会对文本文件开启换行符转换。</p>
<p>下面是一个属性文件的示例，为方便描述标以行号。</p>
<div class="highlight-python"><div class="highlight"><pre>1  *.txt           text
2  *.vcproj        eol=crlf
3  *.sh            eol=lf
4  *.jpg           -text
5  *.jpeg          binary
</pre></div>
</div>
<p>包含了上面属性文件的版本库，会将<tt class="docutils literal"><span class="pre">.txt</span></tt>、<tt class="docutils literal"><span class="pre">.vcproj</span></tt>、<tt class="docutils literal"><span class="pre">.sh</span></tt>为扩展名的文件视为文本文件，在处理过程中会进行换行符转换，而将<tt class="docutils literal"><span class="pre">.jpg</span></tt>、<tt class="docutils literal"><span class="pre">.jpeg</span></tt>为扩展名的文件视为二进制文件，不进行换行符转换。</p>
<p><strong>依据属性文件进行换行符转换</strong></p>
<p>关于属性文件，会在后面的章节详细介绍，现在可以将其理解为工作区目录下的<tt class="file docutils literal"><span class="pre">.gitattributes</span></tt>文件，其文件匹配方法及该文件的作用范围和<tt class="file docutils literal"><span class="pre">.gitignore</span></tt>文件非常类似。</p>
<p>像上面的属性文件示例中，第1行设置了扩展名为<tt class="docutils literal"><span class="pre">.txt</span></tt>的文件具有text属性，则所有扩展名为<tt class="docutils literal"><span class="pre">.txt</span></tt>的文件添加到版本库时，在版本库中创建的blob文件的换行符一律转换为LF。而当扩展名为<tt class="docutils literal"><span class="pre">.txt</span></tt>的文件检出到工作区时，则根据平台的不同使用不同的换行符，如在Linux上检出使用LF换行符，在Windows上检出使用CRLF换行符。</p>
<p>示例中的第2行设置扩展名为<tt class="docutils literal"><span class="pre">.vcproj</span></tt>的文件的属性<tt class="docutils literal"><span class="pre">eol</span></tt>的值为<tt class="docutils literal"><span class="pre">crlf</span></tt>，隐含着该文件属于文本文件的含义，当向版本库添加扩展名为<tt class="docutils literal"><span class="pre">.vcproj</span></tt>文件时，在版本库中创建的blob文件的换行符一律转换为LF。而当该类型的文件检出到工作区时，则一律使用CRLF作为换行符，不管是在Windows上检出，还是在Linux上检出。</p>
<p>同理示例中的第3行设置的扩展名为<tt class="docutils literal"><span class="pre">.sh</span></tt>的文件也会进行类似的换行符转换，区别在于该类型文件无论在哪个平台检出，都使用LF作为换行符。</p>
<p>向上面那样逐一为不同类型的文件设置换行符格式显得很麻烦，可以在属性文件中添加下面的设置，为所有文件开启自动文件类型判断。</p>
<div class="highlight-python"><div class="highlight"><pre>*  text=auto
</pre></div>
</div>
<p>当为所有文件设置了<tt class="docutils literal"><span class="pre">text=auto</span></tt>的属性后，Git就会在文件检入和检出时对文件是否是二进制进行判断，采用前面提到的方法：如果文件头部8000个字符中出现NULL字符则为二进制文件，否则为文本文件。如果判断文件是文本文件就会启用换行符转换。至于本地检出文件采用什么换行符格式，实际上是由<tt class="docutils literal"><span class="pre">core.eol</span></tt>配置变量进行设置的，不过因为<tt class="docutils literal"><span class="pre">core.eol</span></tt>没有设置时采用缺省值<tt class="docutils literal"><span class="pre">native</span></tt>，才使得工作区文本文件的检出采用操作系统默认的换行符格式。配置变量<tt class="docutils literal"><span class="pre">core.eol</span></tt>除了默认的<tt class="docutils literal"><span class="pre">native</span></tt>外，还可以使用<tt class="docutils literal"><span class="pre">lf</span></tt>和<tt class="docutils literal"><span class="pre">crlf</span></tt>，不过一般较少用到。</p>
<p><strong>使用Git配置变量控制换行符转换</strong></p>
<p>在Git 1.7.4之前，用属性文件的方式来设置文件的换行符转换，只能逐一为版本库进行设置，如果要为本地所有的版本库设定文件换行符转换就非常的麻烦。Git 1.7.4提供了全局可用的属性文件，实现了对换行符转换设定的全局控制，我们会在后面的章节加以介绍。现在介绍另外一个方法，即通过配置变量<tt class="docutils literal"><span class="pre">core.autocrlf</span></tt>来开启文本文件换行符转换的功能。例如执行下面的命令，对配置变量<tt class="docutils literal"><span class="pre">core.autocrlf</span></tt>进行设置：</p>
<div class="highlight-python"><div class="highlight"><pre>$ git config --global core.autocrlf true
</pre></div>
</div>
<p>默认Git不对配置变量<tt class="docutils literal"><span class="pre">core.autocrlf</span></tt>进行设置，因此在也没有通过属性文件指定文件类型的情况下，Git不对文件进行换行符转换。但是将配置变量<tt class="docutils literal"><span class="pre">core.autocrlf</span></tt>设置为下列值时，会开启Git对文件类型的智能判别并对文本文件执行换行符转换。</p>
<ul>
<li><p class="first">设置配置变量<tt class="docutils literal"><span class="pre">core.autocrlf</span></tt>为<tt class="docutils literal"><span class="pre">true</span></tt>。</p>
<p>效果就相当于为版本库中所有文件设置了<tt class="docutils literal"><span class="pre">text=auto</span></tt>的属性。即通过Git对文件类型的自动判定，对文本文件进行换行符转换。在版本库的blob文件中使用LF作为换行符，而检出到工作区时无论是什么操作系统都使用CRLF为换行符。注意当设置了<tt class="docutils literal"><span class="pre">core.autocrlf</span></tt>为<tt class="docutils literal"><span class="pre">true</span></tt>时，会忽略<tt class="docutils literal"><span class="pre">core.eol</span></tt>的设置，工作区文件始终使用CRLF作为换行符，这对于Windows下的Git非常适合，但不适用于Linux等操作系统。</p>
</li>
<li><p class="first">设置配置变量<tt class="docutils literal"><span class="pre">core.autocrlf</span></tt>为<tt class="docutils literal"><span class="pre">input</span></tt>。</p>
<p>同样开启文本文件的换行符转换，但只是在文件提交到版本库时，将新增入库的blob文件的换行符转换为LF。当从版本库检出文件到工作区，则不进行文件转换，即版本库中文件若是采用LF换行符，检出仍旧是LF作为换行符。这个设置对Linux等操作系统下的Git非常适合，但不适合于Windows。</p>
</li>
</ul>
<p><strong>配制``core.safecrlf``捕捉异常的换行符转换</strong></p>
<p>无论是用户通过属性文件设定文件的类型，还是通过Git智能判别，都可能错误的将二进制文件识别为文本文件，在转换过程中造成文件的破坏。有一种情况下破坏最为严重，就是误判的文件中包含不一致的换行符（既有CRLF，又有LF），这就会导致保存到版本库中的blob对象无论通过何种转换方式都不能还原回原有的文件。</p>
<p>Git提供了名为<tt class="docutils literal"><span class="pre">core.safecrlf</span></tt>的配置变量，可以用于捕捉这种不可逆的换行符转换，提醒用户注意。将配置变量<tt class="docutils literal"><span class="pre">core.safecrlf</span></tt>设置为<tt class="docutils literal"><span class="pre">true</span></tt>时，如果发现存在不可逆换行符转换时，会报错退出，拒绝执行不可逆的换行符转换。如果将配置变量<tt class="docutils literal"><span class="pre">core.safecrlf</span></tt>设置为<tt class="docutils literal"><span class="pre">warn</span></tt>则允许不可逆的转换，但会发出警告。</p>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="总目录"
             >索引</a></li>
        <li class="right" >
          <a href="050-git-features.html" title="8.2. Git 的其他特性"
             >下一页</a> |</li>
        <li class="right" >
          <a href="030-case-insensitive.html" title="8.1.2. 文件名大小写问题"
             >上一页</a> |</li>
        <li><a href="../index.html">GotGit</a> &raquo;</li>
          <li><a href="index.html" >8. Git杂谈</a> &raquo;</li>
          <li><a href="010-git-cross-os.html" >8.1. 跨平台操作Git</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/"><img alt="知识共享许可协议" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" /></a>
      <br />
      全部内容以 <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Creative Commons 署名-非商业性使用-相同方式共享 3.0 协议发布</a>.
      <br />
        &copy; Copyright 2011, 蒋鑫。
      使用 <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2.3 创建。

    </div>
  </body>
</html>