
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>8.2.5. Git评注 &mdash; GotGit</title>
    
    <link rel="stylesheet" href="../static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="/stylesheets/master.css" type="text/css" />
    <link rel="stylesheet" href="/stylesheets/syntax.css" type="text/css" />
    <link rel="stylesheet" href="../static/worldhello.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../static/jquery.js"></script>
    <script type="text/javascript" src="../static/underscore.js"></script>
    <script type="text/javascript" src="../static/doctools.js"></script>
    <script type="text/javascript" src="../static/translations.js"></script>
    <link rel="top" title="GotGit" href="../index.html" />
    <link rel="up" title="8.2. Git 的其他特性" href="050-git-features.html" />
    <link rel="next" title="9. 附录" href="../90-app/index.html" />
    <link rel="prev" title="8.2.4. 嫁接和替换" href="110-graft-and-replace.html" /> 
  </head>
  <body>
    <div id='header'>
      <h1><a href='/'>World Hello</a></h1>

      <div id='menu'>
        <ul>
          <li><a href='/' id='home-link' title='Home'>首页</a></li>
          <li><a href='/blog.html' id='blog-link' title='Blog'>博客</a></li>
          <li><a href='/doc/' id='docs-link' title='Docs'>文章</a></li>
          <li><a href='/about.html' id='about-link' title='About'>关于</a></li>
          <li><a href='http://github.com/gotgit' target='_blank' title='GitHub' rel='me' id='github-link'>GitHub</a></li>
          <li><a href='http://weibo.com/gotgit' title='微博' target='_blank' id='weibo-link'>微博</a></li>
        </ul>
      </div>
    </div>

    <div class="related">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="总目录"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="../90-app/index.html" title="9. 附录"
             accesskey="N">下一页</a> |</li>
        <li class="right" >
          <a href="110-graft-and-replace.html" title="8.2.4. 嫁接和替换"
             accesskey="P">上一页</a> |</li>
        <li><a href="../index.html">GotGit</a> &raquo;</li>
          <li><a href="index.html" >8. Git杂谈</a> &raquo;</li>
          <li><a href="050-git-features.html" accesskey="U">8.2. Git 的其他特性</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">內容目录</a></h3>
  <ul>
<li><a class="reference internal" href="#">8.2.5. Git评注</a><ul>
<li><a class="reference internal" href="#id1">8.2.5.1. 评注的奥秘</a></li>
<li><a class="reference internal" href="#id2">8.2.5.2. 评注相关命令</a></li>
<li><a class="reference internal" href="#id3">8.2.5.3. 评注相关配置</a></li>
</ul>
</li>
</ul>

  <h4>上一个主题</h4>
  <p class="topless"><a href="110-graft-and-replace.html"
                        title="上一章">8.2.4. 嫁接和替换</a></p>
  <h4>下一个主题</h4>
  <p class="topless"><a href="../90-app/index.html"
                        title="下一章">9. 附录</a></p>
  <h3>本页</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/08-git-misc/120-git-notes.txt"
           rel="nofollow">显示源代码</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>快速搜索</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="转向" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    输入相关的术语，模块，类或者函数名称进行搜索
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="git">
<h1>8.2.5. Git评注<a class="headerlink" href="#git" title="永久链接至标题">¶</a></h1>
<p>从1.6.6版本开始，Git提供了一个<strong class="command">git notes</strong>命令可以为提交添加评注，实现在不改变提交对象的情况下在提交说明的后面附加评注。图41-1展示了Github（<a class="reference external" href="https://github.com/ossxp-com/gitdemo-commit-tree/commit/6652a0dce6a5067732c00ef0a220810a7230655e">https://github.com/ossxp-com/gitdemo-commit-tree/commit/6652a0dce6a5067732c00ef0a220810a7230655e</a>）利用<strong class="command">git notes</strong>实现的在提交显示界面中显示评注（如果存在的话）和添加评注的界面。</p>
<div class="figure">
<a class="reference internal image-reference" href="../images/github-notes.png"><img alt="../images/github-notes.png" src="../images/github-notes.png" style="width: 739.9px; height: 401.1px;" /></a>
<p class="caption">图41-1：Github上显示和添加评注</p>
</div>
<div class="section" id="id1">
<h2>8.2.5.1. 评注的奥秘<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<p>实际上Git评注可以针对任何对象，而且评注的内容也不限于文字，因为评注的内容是保存在Git对象库中的一个blob对象中。不过评注目前最主要的应用还是在提交说明后添加文字评注。</p>
<p>在第2篇“第11.4.6节二分查找”中用到的<tt class="docutils literal"><span class="pre">gitdemo-commit-tree</span></tt>版本库实际上就包含了提交评注，只不过之前尚未将评注获取到本地版本库而已。如果工作区中的<tt class="docutils literal"><span class="pre">gitdemo-commit-tree</span></tt>版本库已经不存在，可以使用下面的命令从GitHub上再克隆一个：</p>
<div class="highlight-python"><div class="highlight"><pre>$ git clone -q git://github.com/ossxp-com/gitdemo-commit-tree.git
$ cd gitdemo-commit-tree
</pre></div>
</div>
<p>执行下面的命令，查看最后一次提交的提交说明：</p>
<div class="highlight-python"><div class="highlight"><pre>$ git log -1
commit 6652a0dce6a5067732c00ef0a220810a7230655e
Author: Jiang Xin &lt;jiangxin@ossxp.com&gt;
Date:   Thu Dec 9 16:07:11 2010 +0800

    Add Images for git treeview.

    Signed-off-by: Jiang Xin &lt;jiangxin@ossxp.com&gt;
</pre></div>
</div>
<p>下面为默认的origin远程版本库再添加一个引用获取表达式，以便在执行<strong class="command">git fetch</strong>命令时能够同步评注相关的引用。命令如下：</p>
<div class="highlight-python"><div class="highlight"><pre>$ git config --add remote.origin.fetch refs/notes/*:refs/notes/*
</pre></div>
</div>
<p>执行<strong class="command">git fetch</strong>会获取到一个新的引用<tt class="docutils literal"><span class="pre">refs/notes/commits</span></tt>，如下：</p>
<div class="highlight-python"><div class="highlight"><pre>$ git fetch
remote: Counting objects: 6, done.
remote: Compressing objects: 100% (5/5), done.
remote: Total 6 (delta 0), reused 0 (delta 0)
Unpacking objects: 100% (6/6), done.
From git://github.com/ossxp-com/gitdemo-commit-tree
 * [new branch]      refs/notes/commits -&gt; refs/notes/commits
</pre></div>
</div>
<p>当获取到新的评注相关的引用之后，再来查看最后一次提交的提交说明。下面的命令输出中提交说明的最后两行就是附加的提交评注。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git log -1
commit 6652a0dce6a5067732c00ef0a220810a7230655e
Author: Jiang Xin &lt;jiangxin@ossxp.com&gt;
Date:   Thu Dec 9 16:07:11 2010 +0800

    Add Images for git treeview.

    Signed-off-by: Jiang Xin &lt;jiangxin@ossxp.com&gt;

Notes:
    Bisect test: Bad commit, for doc/B.txt exists.
</pre></div>
</div>
<p>附加的提交评注来自于哪里呢？显然应该和刚刚获取到的引用相关。查看一下获取到的最新引用，会发现引用<tt class="docutils literal"><span class="pre">refs/notes/commits</span></tt>指向的是一个提交对象。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git show-ref refs/notes/commits
6f01cdc59004892741119318ceb2330d6dc0cef1 refs/notes/commits
$ git cat-file -t refs/notes/commits
commit
</pre></div>
</div>
<p>既然新获取的评注引用是一个提交对象，那么就应该能够查看评注引用的提交日志：</p>
<div class="highlight-python"><div class="highlight"><pre>$ git log --stat refs/notes/commits
commit 6f01cdc59004892741119318ceb2330d6dc0cef1
Author: Jiang Xin &lt;jiangxin@ossxp.com&gt;
Date:   Tue Feb 22 09:32:10 2011 +0800

    Notes added by &#39;git notes add&#39;

 6652a0dce6a5067732c00ef0a220810a7230655e |    1 +
 1 files changed, 1 insertions(+), 0 deletions(-)

commit 9771e1076d2218922acc9800f23d5e78d5894a9f
Author: Jiang Xin &lt;jiangxin@ossxp.com&gt;
Date:   Tue Feb 22 09:31:54 2011 +0800

    Notes added by &#39;git notes add&#39;

 e80aa7481beda65ae00e35afc4bc4b171f9b0ebf |    1 +
 1 files changed, 1 insertions(+), 0 deletions(-)
</pre></div>
</div>
<p>从上面的评注引用的提交日志可以看出，存在两次提交，并且从提交说明可以看出是使用<strong class="command">git notes add</strong>命令添加的。至于每次提交添加的文件却很让人困惑，所添加文件的文件名居然是40位的哈希值。</p>
<p>您当然可以通过<strong class="command">git checkout -b</strong>命令检出该引用来研究其中所包含的文件，不过也可以运用我们已经学习到的Git命令直接对其进行研究。</p>
<ul>
<li><p class="first">用<strong class="command">git show</strong>命令显示目录树。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git show -p refs/notes/commits^{tree}
tree refs/notes/commits^{tree}

6652a0dce6a5067732c00ef0a220810a7230655e
e80aa7481beda65ae00e35afc4bc4b171f9b0ebf
</pre></div>
</div>
</li>
<li><p class="first">用<strong class="command">git ls-tree</strong>命令查看文件大小及对应的blob对象的SHA1哈希值。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git ls-tree -l refs/notes/commits
100644 blob 80b1d249069959ce5d83d52ef7bd0507f774c2b0      47    6652a0dce6a5067732c00ef0a220810a7230655e
100644 blob e894f2164e77abf08d95d9bdad4cd51d00b47845      56    e80aa7481beda65ae00e35afc4bc4b171f9b0ebf
</pre></div>
</div>
</li>
<li><p class="first">文件名既然是一个40位的SHA1哈希值，那么文件名一定有意义，通过下面的命令可以看到文件名包含的40位哈希值实际对应于一个提交。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git cat-file -p 6652a0dce6a5067732c00ef0a220810a7230655e
tree e33be9e8e7ca5f887c7d5601054f2f510e6744b8
parent 81993234fc12a325d303eccea20f6fd629412712
author Jiang Xin &lt;jiangxin@ossxp.com&gt; 1291882031 +0800
committer Jiang Xin &lt;jiangxin@ossxp.com&gt; 1291882892 +0800

Add Images for git treeview.

Signed-off-by: Jiang Xin &lt;jiangxin@ossxp.com&gt;
</pre></div>
</div>
</li>
<li><p class="first">用<strong class="command">git cat-file</strong>命令查看该文件的内容，可以看到其内容就是附加在相应提交上的评注。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git cat-file -p refs/notes/commits:6652a0dce6a5067732c00ef0a220810a7230655e
Bisect test: Bad commit, for doc/B.txt exists.
</pre></div>
</div>
</li>
</ul>
<p>综上所述，评注记录在一个blob对象中，并且以所评注对象的SHA1哈希值命名。因为对象SHA1哈希值的唯一性，所以可以将评注都放在同一个文件系统下而不会相互覆盖。针对这个包含所有评注的特殊的文件系统的更改被提交到一个特殊的引用<tt class="docutils literal"><span class="pre">refs/notes/commits</span></tt>当中。</p>
</div>
<div class="section" id="id2">
<h2>8.2.5.2. 评注相关命令<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<p>Git提供了<strong class="command">git notes</strong>命令，对评注进行管理。如果执行<strong class="command">git notes list</strong>或者像下面这样不带任何参数进行调用，会显示和上面<strong class="command">git ls-tree</strong>类似的输出：</p>
<div class="highlight-python"><div class="highlight"><pre>$ git notes
80b1d249069959ce5d83d52ef7bd0507f774c2b0 6652a0dce6a5067732c00ef0a220810a7230655e
e894f2164e77abf08d95d9bdad4cd51d00b47845 e80aa7481beda65ae00e35afc4bc4b171f9b0ebf
</pre></div>
</div>
<p>右边的一列是要评注的提交对象，而左边一列是附加在对应提交上的包含评注内容的blob对象。显示附加在某个提交上的评注可以使用<strong class="command">git notes show</strong>命令。如下：</p>
<div class="highlight-python"><div class="highlight"><pre>$ git notes show G^0
Bisect test: Good commit, for doc/B.txt does not exist.
</pre></div>
</div>
<p>注意上面的命令中使用<tt class="docutils literal"><span class="pre">G^0</span></tt>而非<tt class="docutils literal"><span class="pre">G</span></tt>，是因为<tt class="docutils literal"><span class="pre">G</span></tt>是一个里程碑对象，而评注是建立在由里程碑对象所指向的一个提交对象上。</p>
<p>添加评注可以使用下面的<strong class="command">git notes add</strong>和<strong class="command">git notes append</strong>子命令：</p>
<div class="highlight-python"><div class="highlight"><pre>用法1：git notes add [-f] [-F &lt;file&gt; | -m &lt;msg&gt; | (-c | -C) &lt;object&gt;] [&lt;object&gt;]
用法2：git notes append [-F &lt;file&gt; | -m &lt;msg&gt; | (-c | -C) &lt;object&gt;] [&lt;object&gt;]
</pre></div>
</div>
<p>用法1是添加评注，而用法2是在已有评注后面追加。两者的命令行格式和<strong class="command">git commit</strong>非常类似，可以用类似写提交说明的方法写提交评注。如果省略最后一个<tt class="docutils literal"><span class="pre">&lt;object&gt;</span></tt>参数，则意味着向头指针HEAD添加评注。子命令<strong class="command">git notes add</strong>中的参数<tt class="docutils literal"><span class="pre">-f</span></tt>意味着强制添加，会覆盖对象已有的评注。</p>
<p>使用<strong class="command">git notes copy</strong>子命令可以将一个对象的评注拷贝到另外一个对象上。</p>
<div class="highlight-python"><div class="highlight"><pre>用法：git notes copy [-f] ( --stdin | &lt;from-object&gt; &lt;to-object&gt; )
</pre></div>
</div>
<p>修改评注可以使用下面的<strong class="command">git notes edit</strong>子命令：</p>
<div class="highlight-python"><div class="highlight"><pre>用法：git notes edit [&lt;object&gt;]
</pre></div>
</div>
<p>删除评注可以使用的<strong class="command">git notes remote</strong>子命令，而<strong class="command">git notes prune</strong>则可以清除已经不存在的对象上的评注。用法如下：</p>
<div class="highlight-python"><div class="highlight"><pre>用法1：git notes remove [&lt;object&gt;]
用法2：git notes prune [-n | -v]
</pre></div>
</div>
<p>评注以文件形式保存在特殊的引用中，如果该引用被共享并且同时有多人撰写评注时，有可能出现该引用的合并冲突。可以用<strong class="command">git notes merge</strong>命令来解决合并冲突。评注引用也可以使用其他的引用名称，合并其他的评注引用也可以使用本命令。下面是<strong class="command">git notes merge</strong>命令的语法格式，具体操作参见<strong class="command">git help notes</strong>帮助。</p>
<div class="highlight-python"><div class="highlight"><pre>用法1：git notes merge [-v | -q] [-s &lt;strategy&gt; ] &lt;notes_ref&gt;
用法2：git notes merge --commit [-v | -q]
用法3：git notes merge --abort [-v | -q]
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h2>8.2.5.3. 评注相关配置<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<p>默认提交评注保存在引用<tt class="docutils literal"><span class="pre">refs/notes/commits</span></tt>中，这个默认的设置可以通过<tt class="docutils literal"><span class="pre">core.notesRef</span></tt>配置变量修改。如须更改，要在<tt class="docutils literal"><span class="pre">core.notesRef</span></tt>配置变量中使用引用的全称而不能使用缩写。</p>
<p>在执行<strong class="command">git log</strong>命令显示提交评注的时候，如果配置了<tt class="docutils literal"><span class="pre">notes.</span> <span class="pre">displayRef</span></tt>配置变量（可以使用通配符，并且可以配置多个），则在显示提交评注时，除了会参考<tt class="docutils literal"><span class="pre">core.notesRef</span></tt>设定的引用（或默认的<tt class="docutils literal"><span class="pre">refs/notes/commits</span></tt>引用）外，还会参考<tt class="docutils literal"><span class="pre">notes.displayRef</span></tt>指向的引用（一个或多个）来显示评注。</p>
<p>配置变量<tt class="docutils literal"><span class="pre">notes.rewriteRef</span></tt>用于配置哪个/哪些引用中的提交评注会随着提交的修改而复制到新的提交之上。这个配置变量可以使用多次，或者使用通配符，但该配置变量没有缺省值，因此为了使得提交评注能够随着提交的修改（修补提交、变基等）继续保持，必须对该配置变量进行设定。如：</p>
<div class="highlight-python"><div class="highlight"><pre>$ git config --global notes.rewriteRef refs/notes/*
</pre></div>
</div>
<p>还有<tt class="docutils literal"><span class="pre">notes.rewrite.amend</span></tt>和<tt class="docutils literal"><span class="pre">notes.rewrite.rebase</span></tt>配置变量可以分别对两种提交修改模式（amend和rebase）是否启用评注复制进行设置，默认启用。配置变量<tt class="docutils literal"><span class="pre">notes.rewriteMode</span></tt>默认设置为<tt class="docutils literal"><span class="pre">concatenate</span></tt>，即提交评注复制到修改后的提交时，如果已有评注则对评注进行合并操作。</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>导航</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="总目录"
             >索引</a></li>
        <li class="right" >
          <a href="../90-app/index.html" title="9. 附录"
             >下一页</a> |</li>
        <li class="right" >
          <a href="110-graft-and-replace.html" title="8.2.4. 嫁接和替换"
             >上一页</a> |</li>
        <li><a href="../index.html">GotGit</a> &raquo;</li>
          <li><a href="index.html" >8. Git杂谈</a> &raquo;</li>
          <li><a href="050-git-features.html" >8.2. Git 的其他特性</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/"><img alt="知识共享许可协议" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" /></a>
      <br />
      全部内容以 <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Creative Commons 署名-非商业性使用-相同方式共享 3.0 协议发布</a>.
      <br />
        &copy; Copyright 2011, 蒋鑫。
      使用 <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2.3 创建。

    </div>
  </body>
</html>